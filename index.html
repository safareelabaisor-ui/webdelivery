<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>บัญชีเดลิเวอรี่ รายรับ-รายจ่าย ร้านโครตจะแมน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
    </style>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, query, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDN2AeIQDd4lOgFj3uW1DSSJHybfw0sl78",
            authDomain: "my-delivery-app-89237.firebaseapp.com",
            projectId: "my-delivery-app-89237",
            storageBucket: "my-delivery-app-89237.firebasestorage.app",
            messagingSenderId: "57996698405",
            appId: "1:57996698405:web:5f7efa6c439d24f0abf0cc",
            measurementId: "G-FM7S14RX3R"
        };
        const appId = "my-delivery-app-89237";
        
        // Initialize Firebase
        let app = null;
        let auth = null;
        let db = null;
        let userId = null;
        let myChart = null;
        
        document.addEventListener('DOMContentLoaded', async () => {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug');
                console.log("Firebase initialized.");

                onAuthStateChanged(auth, (user) => {
                    const loadingState = document.getElementById('loading-state');
                    const mainContent = document.getElementById('main-content');
                    const loginContent = document.getElementById('login-content');
                    const logoutBtn = document.getElementById('logout-btn');
                    const userIdDisplay = document.getElementById('user-id');

                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        console.log("User authenticated:", userId);
                        loadingState.classList.add('hidden');
                        loginContent.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        logoutBtn.classList.remove('hidden');
                        setupDataListeners();
                        populateMonthYearSelects();
                    } else {
                        console.log("No user signed in.");
                        loadingState.classList.add('hidden');
                        loginContent.classList.remove('hidden');
                        mainContent.classList.add('hidden');
                        logoutBtn.classList.add('hidden');
                    }
                });

                // Login with Google
                document.getElementById('login-btn').addEventListener('click', async () => {
                    const provider = new GoogleAuthProvider();
                    try {
                        await signInWithPopup(auth, provider);
                    } catch (error) {
                        console.error("Error signing in with Google:", error);
                    }
                });
                
                document.getElementById('logout-btn').addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                    } catch (error) {
                        console.error("Error signing out:", error);
                    }
                });

            } else {
                console.error("Firebase config is missing. The app cannot function without it.");
                document.getElementById('loading-state').innerHTML = `<p class="text-red-500 font-bold">Error: Firebase configuration is missing.</p>`;
                document.getElementById('loading-state').classList.remove('hidden');
            }
        });

        // Event listener for form submission
        document.getElementById('transaction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || !userId) {
                console.error("Firebase is not initialized or user is not authenticated.");
                return;
            }

            const formData = new FormData(e.target);
            const data = {
                timestamp: new Date(),
                date: formData.get('date'),
                item: formData.get('item'),
                order_list: formData.get('order_list'),
                channel: formData.get('channel'),
                income: parseFloat(formData.get('income')) || 0,
                gp_fee_excl_vat: parseFloat(formData.get('gp_fee_excl_vat')) || 0,
                shipping_discount_fee_excl_vat: parseFloat(formData.get('shipping_discount_fee_excl_vat')) || 0,
                vat_amount: parseFloat(formData.get('vat_amount')) || 0,
                raw_material_cost: parseFloat(formData.get('raw_material_cost')) || 0,
                expense: parseFloat(formData.get('expense')) || 0,
                note: formData.get('note'),
                buyer_name: formData.get('buyer_name'),
                order_id: formData.get('order_id'),
                order_number: formData.get('order_number'),
                driver_name: formData.get('driver_name')
            };

            try {
                const transactionsColRef = collection(db, `artifacts/${appId}/public/data/transactions`);
                await addDoc(transactionsColRef, data);
                e.target.reset(); // Clear form after successful submission
                console.log("Transaction added successfully.");
            } catch (error) {
                console.error("Error adding document: ", error);
            }
        });

        // Listen for real-time data updates
        function setupDataListeners() {
            if (!db || !userId) {
                console.error("Firebase is not initialized or user is not authenticated.");
                return;
            }

            const transactionsColRef = collection(db, `artifacts/${appId}/public/data/transactions`);
            const q = query(transactionsColRef);

            onSnapshot(q, (querySnapshot) => {
                let transactions = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    transactions.push({ id: doc.id, ...data, timestamp: data.timestamp ? data.timestamp.toDate() : new Date() });
                });

                // Sort transactions by date and timestamp in memory
                transactions.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    if (dateA - dateB !== 0) {
                        return dateA - dateB;
                    }
                    return a.timestamp - b.timestamp;
                });

                displayTransactions(transactions);
                updateMonthlySummary(transactions);
                updateChart(transactions);
            }, (error) => {
                console.error("Error listening to transactions:", error);
            });
        }

        // Populate month and year dropdowns
        function populateMonthYearSelects() {
            const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            const monthSelect = document.getElementById('summary-month');
            const yearSelect = document.getElementById('summary-year');
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();

            monthSelect.innerHTML = '';
            yearSelect.innerHTML = '';

            for (let i = 0; i < months.length; i++) {
                const option = document.createElement('option');
                option.value = i + 1;
                option.textContent = months[i];
                if (i === currentMonth) {
                    option.selected = true;
                }
                monthSelect.appendChild(option);
            }

            for (let i = currentYear - 5; i <= currentYear; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }

            monthSelect.addEventListener('change', () => setupDataListeners());
            yearSelect.addEventListener('change', () => setupDataListeners());
        }
        
        // Update monthly summary
        function updateMonthlySummary(transactions = []) {
            const selectedMonth = parseInt(document.getElementById('summary-month').value);
            const selectedYear = parseInt(document.getElementById('summary-year').value);

            let monthlyIncome = 0;
            let monthlyExpense = 0;

            transactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                const totalTransactionExpense = (transaction.expense || 0) + (transaction.gp_fee_excl_vat || 0) + (transaction.shipping_discount_fee_excl_vat || 0) + (transaction.vat_amount || 0) + (transaction.raw_material_cost || 0);

                if (transactionDate.getMonth() + 1 === selectedMonth && transactionDate.getFullYear() === selectedYear) {
                    monthlyIncome += (transaction.income || 0);
                    monthlyExpense += totalTransactionExpense;
                }
            });

            document.getElementById('monthly-income').textContent = monthlyIncome.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('monthly-expense').textContent = monthlyExpense.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const monthlyProfit = monthlyIncome - monthlyExpense;
            document.getElementById('monthly-profit').textContent = monthlyProfit.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('monthly-profit').classList.remove('text-emerald-600', 'text-rose-600');
            document.getElementById('monthly-profit').classList.add(monthlyProfit >= 0 ? 'text-emerald-600' : 'text-rose-600');
        }

        // Update the chart
        function updateChart(transactions = []) {
            const monthlyData = transactions.reduce((acc, transaction) => {
                const transactionDate = new Date(transaction.date);
                const month = transactionDate.getMonth() + 1;
                const year = transactionDate.getFullYear();
                const key = `${year}-${month}`;

                if (!acc[key]) {
                    acc[key] = { income: 0, expense: 0, date: transactionDate };
                }

                const totalTransactionExpense = (transaction.expense || 0) + (transaction.gp_fee_excl_vat || 0) + (transaction.shipping_discount_fee_excl_vat || 0) + (transaction.vat_amount || 0) + (transaction.raw_material_cost || 0);
                acc[key].income += (transaction.income || 0);
                acc[key].expense += totalTransactionExpense;

                return acc;
            }, {});

            const sortedKeys = Object.keys(monthlyData).sort();
            const labels = sortedKeys.map(key => {
                const [year, month] = key.split('-');
                return `เดือน ${month}/${year}`;
            });
            const incomeData = sortedKeys.map(key => monthlyData[key].income);
            const expenseData = sortedKeys.map(key => monthlyData[key].expense);

            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: 'รายรับ',
                        data: incomeData,
                        borderColor: 'rgb(16, 185, 129)', // Tailwind's green-500
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        tension: 0.1,
                        fill: true
                    },
                    {
                        label: 'รายจ่าย',
                        data: expenseData,
                        borderColor: 'rgb(244, 63, 94)', // Tailwind's rose-500
                        backgroundColor: 'rgba(244, 63, 94, 0.2)',
                        tension: 0.1,
                        fill: true
                    }
                ]
            };

            if (myChart) {
                myChart.data = chartData;
                myChart.update();
            } else {
                const ctx = document.getElementById('myChart').getContext('2d');
                myChart = new Chart(ctx, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        label += context.parsed.y.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' บาท';
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value, index, ticks) {
                                        return value.toLocaleString('th-TH') + ' บาท';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Display transactions in the table and update summary
        function displayTransactions(transactions) {
            const tableBody = document.getElementById('transaction-table-body');
            const totalIncomeEl = document.getElementById('total-income');
            const totalExpenseEl = document.getElementById('total-expense');
            const totalProfitEl = document.getElementById('total-profit');

            tableBody.innerHTML = '';
            let totalIncome = 0;
            let totalExpense = 0;

            if (transactions.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="16" class="text-center py-4 text-gray-500">ยังไม่มีข้อมูลการทำธุรกรรม</td></tr>`;
            }

            transactions.forEach(transaction => {
                const totalTransactionExpense = (transaction.expense || 0) + (transaction.gp_fee_excl_vat || 0) + (transaction.shipping_discount_fee_excl_vat || 0) + (transaction.vat_amount || 0) + (transaction.raw_material_cost || 0);
                totalIncome += (transaction.income || 0);
                totalExpense += totalTransactionExpense;

                const profit = (transaction.income || 0) - totalTransactionExpense;
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'text-gray-700', 'text-sm');
                row.innerHTML = `
                    <td class="px-4 py-2 border-b whitespace-nowrap">${transaction.date.split('T')[0]}</td>
                    <td class="px-4 py-2 border-b">${transaction.channel || ''}</td>
                    <td class="px-4 py-2 border-b">${transaction.order_number || ''}</td>
                    <td class="px-4 py-2 border-b">${transaction.buyer_name || ''}</td>
                    <td class="px-4 py-2 border-b">${transaction.driver_name || ''}</td>
                    <td class="px-4 py-2 border-b">${transaction.item || ''}</td>
                    <td class="px-4 py-2 border-b">${transaction.order_list || ''}</td>
                    <td class="px-4 py-2 border-b text-right">${(transaction.income || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-4 py-2 border-b text-right">${(transaction.gp_fee_excl_vat || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-4 py-2 border-b text-right">${(transaction.shipping_discount_fee_excl_vat || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-4 py-2 border-b text-right">${(transaction.vat_amount || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-4 py-2 border-b text-right">${(transaction.raw_material_cost || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-4 py-2 border-b text-right">${(transaction.expense || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-4 py-2 border-b text-right ${profit >= 0 ? 'text-teal-600' : 'text-rose-600'}">${profit.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-4 py-2 border-b">${transaction.note || ''}</td>
                    <td class="px-4 py-2 border-b text-center space-x-2 whitespace-nowrap">
                        <button onclick="window.showEditModal('${transaction.id}', '${transaction.note || ''}', '${transaction.buyer_name || ''}', '${transaction.order_id || ''}', '${transaction.order_number || ''}', '${transaction.driver_name || ''}', ${transaction.income || 0}, ${transaction.gp_fee_excl_vat || 0}, ${transaction.shipping_discount_fee_excl_vat || 0}, ${transaction.expense || 0}, '${transaction.order_list || ''}', ${transaction.vat_amount || 0}, ${transaction.raw_material_cost || 0})" class="text-blue-500 hover:text-blue-700 font-medium">แก้ไข</button>
                        <button onclick="window.showDeleteModal('${transaction.id}')" class="text-red-500 hover:text-red-700 font-medium">ลบ</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            totalIncomeEl.textContent = totalIncome.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            totalExpenseEl.textContent = totalExpense.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            totalProfitEl.textContent = (totalIncome - totalExpense).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            totalProfitEl.classList.remove('text-teal-600', 'text-rose-600');
            totalProfitEl.classList.add((totalIncome - totalExpense) >= 0 ? 'text-teal-600' : 'text-rose-600');
        }

        // Modal Logic
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');

        window.showEditModal = (id, note, buyer_name, order_id, order_number, driver_name, income, gp_fee_excl_vat, shipping_discount_fee_excl_vat, expense, order_list, vat_amount, raw_material_cost) => {
            modalTitle.textContent = 'แก้ไขรายการ';
            modalBody.innerHTML = `
                <div class="space-y-4 text-left">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อผู้ซื้อ</label>
                        <input type="text" id="modal-buyer-name" value="${buyer_name}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">รหัสใบสั่งซื้อ</label>
                        <input type="text" id="modal-order-id" value="${order_id}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">เลขออเดอร์</label>
                        <input type="text" id="modal-order-number" value="${order_number}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">คนขับ</label>
                        <input type="text" id="modal-driver-name" value="${driver_name}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">รายการสั่งซื้อ</label>
                        <textarea id="modal-order-list" class="w-full px-3 py-2 border border-gray-300 rounded-md">${order_list}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">รายรับ</label>
                        <input type="number" id="modal-income" value="${income}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ค่าใช้จ่าย GP (ไม่รวม VAT)</label>
                        <input type="number" id="modal-gp-fee-excl-vat" value="${gp_fee_excl_vat}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ค่าส่วนลดค่าส่ง (ไม่รวม VAT)</label>
                        <input type="number" id="modal-shipping-discount-fee-excl-vat" value="${shipping_discount_fee_excl_vat}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ค่า VAT</label>
                        <input type="number" id="modal-vat-amount" value="${vat_amount}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ค่าวัตถุดิบ</label>
                        <input type="number" id="modal-raw-material-cost" value="${raw_material_cost}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ค่าใช้จ่ายอื่นๆ</label>
                        <input type="number" id="modal-expense" value="${expense}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
                        <input type="text" id="modal-note" value="${note}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>
            `;
            modalConfirm.onclick = () => {
                const newIncome = parseFloat(document.getElementById('modal-income').value);
                const newGpFeeExclVat = parseFloat(document.getElementById('modal-gp-fee-excl-vat').value);
                const newShippingDiscountFeeExclVat = parseFloat(document.getElementById('modal-shipping-discount-fee-excl-vat').value);
                const newVatAmount = parseFloat(document.getElementById('modal-vat-amount').value);
                const newRawMaterialCost = parseFloat(document.getElementById('modal-raw-material-cost').value);
                const newExpense = parseFloat(document.getElementById('modal-expense').value);
                const newNote = document.getElementById('modal-note').value;
                const newBuyerName = document.getElementById('modal-buyer-name').value;
                const newOrderNumber = document.getElementById('modal-order-number').value;
                const newDriverName = document.getElementById('modal-driver-name').value;
                const newOrderList = document.getElementById('modal-order-list').value;
                editTransaction(id, newIncome, newGpFeeExclVat, newShippingDiscountFeeExclVat, newVatAmount, newRawMaterialCost, newExpense, newNote, newBuyerName, newOrderNumber, newDriverName, newOrderList);
                modal.style.display = 'none';
            };
            modalCancel.onclick = () => {
                modal.style.display = 'none';
            };
            modal.style.display = 'flex';
        };

        window.showDeleteModal = (id) => {
            modalTitle.textContent = 'ยืนยันการลบ';
            modalBody.innerHTML = `<p>คุณแน่ใจหรือไม่ที่จะลบรายการนี้?</p>`;
            modalConfirm.onclick = () => {
                deleteTransaction(id);
                modal.style.display = 'none';
            };
            modalCancel.onclick = () => {
                modal.style.display = 'none';
            };
            modal.style.display = 'flex';
        };

        async function editTransaction(id, newIncome, newGpFeeExclVat, newShippingDiscountFeeExclVat, newVatAmount, newRawMaterialCost, newExpense, newNote, newBuyerName, newOrderNumber, newDriverName, newOrderList) {
            if (!db || !userId) return;
            try {
                const transactionRef = doc(db, `artifacts/${appId}/public/data/transactions`, id);
                await updateDoc(transactionRef, { 
                    income: newIncome, 
                    gp_fee_excl_vat: newGpFeeExclVat, 
                    shipping_discount_fee_excl_vat: newShippingDiscountFeeExclVat, 
                    vat_amount: newVatAmount,
                    raw_material_cost: newRawMaterialCost,
                    expense: newExpense, 
                    note: newNote,
                    buyer_name: newBuyerName,
                    order_number: newOrderNumber,
                    driver_name: newDriverName,
                    order_list: newOrderList
                });
                console.log("Transaction updated successfully.");
            } catch (error) {
                console.error("Error updating document:", error);
            }
        }

        async function deleteTransaction(id) {
            if (!db || !userId) return;
            try {
                const transactionRef = doc(db, `artifacts/${appId}/public/data/transactions`, id);
                await deleteDoc(transactionRef);
                console.log("Transaction deleted successfully.");
            } catch (error) {
                console.error("Error deleting document:", error);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };
    </script>
</head>

<body class="bg-gray-100 font-sans leading-normal tracking-normal">
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800">บัญชีรายรับ-รายจ่าย เดลิเวอรี่</h1>
            <p class="text-lg text-gray-600 mt-2">สำหรับร้านโครตจะแมน</p>
        </header>

        <div id="loading-state" class="flex flex-col items-center justify-center min-h-[50vh]">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-gray-900 mx-auto"></div>
            <p class="mt-4 text-gray-600">กำลังเชื่อมต่อฐานข้อมูล...</p>
        </div>
        
        <div id="login-content" class="flex flex-col items-center justify-center min-h-[50vh] hidden">
            <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">ยินดีต้อนรับ</h2>
                <p class="text-gray-600 mb-6">เข้าสู่ระบบด้วยบัญชี Google เพื่อเริ่มบันทึกข้อมูล</p>
                <button id="login-btn" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-md shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    เข้าสู่ระบบด้วย Google
                </button>
            </div>
        </div>

        <main id="main-content" class="hidden">
            <div class="flex justify-end mb-4">
                <button id="logout-btn" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-md shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">ออกจากระบบ</button>
            </div>

            <section class="bg-white p-6 rounded-lg shadow-xl mb-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">สรุปยอดทั้งหมด</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="bg-teal-700 p-4 rounded-lg shadow-sm">
                        <p class="text-lg text-white">รายรับรวม</p>
                        <p class="text-3xl font-extrabold text-white mt-1">฿<span id="total-income">0.00</span></p>
                    </div>
                    <div class="bg-rose-700 p-4 rounded-lg shadow-sm">
                        <p class="text-lg text-white">รายจ่ายรวม</p>
                        <p class="text-3xl font-extrabold text-white mt-1">฿<span id="total-expense">0.00</span></p>
                    </div>
                    <div class="bg-teal-700 p-4 rounded-lg shadow-sm">
                        <p class="text-lg text-white">กำไร/ขาดทุน</p>
                        <p class="text-3xl font-extrabold text-white mt-1">฿<span id="total-profit">0.00</span></p>
                    </div>
                </div>
            </section>
            
            <section class="bg-white p-6 rounded-lg shadow-xl mb-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">สรุปยอดรายเดือน</h2>
                <div class="flex flex-col sm:flex-row gap-4 mb-4">
                    <select id="summary-month" class="w-full sm:w-1/2 px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400"></select>
                    <select id="summary-year" class="w-full sm:w-1/2 px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400"></select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="bg-sky-200 p-4 rounded-lg shadow-sm">
                        <p class="text-lg text-gray-600">รายรับรายเดือน</p>
                        <p class="text-3xl font-extrabold text-sky-800 mt-1">฿<span id="monthly-income">0.00</span></p>
                    </div>
                    <div class="bg-rose-200 p-4 rounded-lg shadow-sm">
                        <p class="text-lg text-gray-600">รายจ่ายรายเดือน</p>
                        <p class="text-3xl font-extrabold text-rose-800 mt-1">฿<span id="monthly-expense">0.00</span></p>
                    </div>
                    <div class="bg-emerald-200 p-4 rounded-lg shadow-sm">
                        <p class="text-lg text-gray-600">กำไรรายเดือน</p>
                        <p class="text-3xl font-extrabold text-emerald-800 mt-1">฿<span id="monthly-profit">0.00</span></p>
                    </div>
                </div>
                <div class="mt-8">
                    <canvas id="myChart"></canvas>
                </div>
            </section>

            <section class="bg-white p-6 rounded-lg shadow-xl mb-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">เพิ่มรายการใหม่</h2>
                <div class="bg-yellow-100 p-3 rounded-lg text-yellow-800 text-sm mb-4">
                    💡 User ID: <span id="user-id" class="font-mono break-all"></span>
                </div>
                <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700 mb-1">วัน/เวลา</label>
                        <input type="datetime-local" id="date" name="date" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="channel" class="block text-sm font-medium text-gray-700 mb-1">ช่องทาง</label>
                        <select id="channel" name="channel" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                            <option value="">เลือกช่องทาง</option>
                            <option value="ShopeeFood">ShopeeFood</option>
                            <option value="Lineman">Lineman</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                    <div>
                        <label for="order_number" class="block text-sm font-medium text-gray-700 mb-1">เลขออเดอร์</label>
                        <input type="text" id="order_number" name="order_number" placeholder="ใส่เลขออเดอร์"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="buyer_name" class="block text-sm font-medium text-gray-700 mb-1">ชื่อผู้ซื้อ</label>
                        <input type="text" id="buyer_name" name="buyer_name" placeholder="ชื่อผู้ซื้อ"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="driver_name" class="block text-sm font-medium text-gray-700 mb-1">คนขับ</label>
                        <input type="text" id="driver_name" name="driver_name" placeholder="ชื่อคนขับ"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="item" class="block text-sm font-medium text-gray-700 mb-1">รายการ</label>
                        <input type="text" id="item" name="item" placeholder="เช่น ก๋วยเตี๋ยว, ข้าวผัด"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div class="md:col-span-3">
                        <label for="order_list" class="block text-sm font-medium text-gray-700 mb-1">รายการสั่งซื้อ</label>
                        <textarea id="order_list" name="order_list" rows="3" placeholder="เช่น ก๋วยเตี๋ยว 1, ข้าวผัด 2, น้ำเปล่า 1"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400"></textarea>
                    </div>
                    <div>
                        <label for="income" class="block text-sm font-medium text-gray-700 mb-1">รายรับ</label>
                        <input type="number" id="income" name="income" step="0.01" value="0.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="gp_fee_excl_vat" class="block text-sm font-medium text-gray-700 mb-1">ค่าใช้จ่าย GP (ไม่รวม VAT)</label>
                        <input type="number" id="gp_fee_excl_vat" name="gp_fee_excl_vat" step="0.01" value="0.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="shipping_discount_fee_excl_vat" class="block text-sm font-medium text-gray-700 mb-1">ค่าส่วนลดค่าส่ง (ไม่รวม VAT)</label>
                        <input type="number" id="shipping_discount_fee_excl_vat" name="shipping_discount_fee_excl_vat" step="0.01" value="0.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="vat_amount" class="block text-sm font-medium text-gray-700 mb-1">ค่า VAT</label>
                        <input type="number" id="vat_amount" name="vat_amount" step="0.01" value="0.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="raw_material_cost" class="block text-sm font-medium text-gray-700 mb-1">ค่าวัตถุดิบ</label>
                        <input type="number" id="raw_material_cost" name="raw_material_cost" step="0.01" value="0.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="expense" class="block text-sm font-medium text-gray-700 mb-1">ค่าใช้จ่ายอื่นๆ</label>
                        <input type="number" id="expense" name="expense" step="0.01" value="0.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div class="md:col-span-3">
                        <label for="note" class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
                        <input type="text" id="note" name="note" placeholder="รายละเอียดเพิ่มเติม (ถ้ามี)"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div class="md:col-span-3 text-right">
                        <button type="submit"
                            class="mt-4 px-6 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            บันทึกรายการ
                        </button>
                    </div>
                </form>
            </section>

            <section class="bg-white p-6 rounded-lg shadow-xl border border-gray-200 overflow-x-auto">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">ประวัติการทำธุรกรรม</h2>
                <div class="bg-yellow-100 p-3 rounded-lg text-yellow-800 text-sm mb-4">
                    💡 User ID: <span id="user-id" class="font-mono break-all"></span>
                </div>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">วัน/เวลา</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">ช่องทาง</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">เลขออเดอร์</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">ชื่อผู้ซื้อ</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">คนขับ</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">รายการ</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">รายการสั่งซื้อ</th>
                            <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">รายรับ (บาท)</th>
                            <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">ค่า GP (ไม่รวม VAT)</th>
                            <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">ค่าส่วนลด (ไม่รวม VAT)</th>
                            <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">ค่า VAT</th>
                            <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">ค่าวัตถุดิบ (บาท)</th>
                            <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">ค่าใช้จ่ายอื่นๆ (บาท)</th>
                            <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">กำไร (บาท)</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">หมายเหตุ</th>
                            <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Transaction rows will be injected here by JavaScript -->
                    </tbody>
                </table>
            </section>
        </main>

        <!-- Modal for user interaction -->
        <div id="modal" class="modal">
            <div class="modal-content">
                <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
                <div id="modal-body" class="mb-4"></div>
                <div class="flex justify-center space-x-4">
                    <button id="modal-confirm" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">ยืนยัน</button>
                    <button id="modal-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">ยกเลิก</button>
                </div>
            </div>
        </div>

    </div>
</body>

</html>
