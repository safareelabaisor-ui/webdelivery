<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>บัญชีเดลิเวอรี่ รายรับ-รายจ่าย ร้านโครตจะแมน</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
    </style>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDN2AeIQDd4lOgFj3uW1DSSJHybfw0sl78",
            authDomain: "my-delivery-app-89237.firebaseapp.com",
            projectId: "my-delivery-app-89237",
            storageBucket: "my-delivery-app-89237.firebasestorage.app",
            messagingSenderId: "57996698405",
            appId: "1:57996698405:web:5f7efa6c439d24f0abf0cc",
            measurementId: "G-FM7S14RX3R"
        };
        const appId = "my-delivery-app-89237";
        
        // Initialize Firebase
        let app = null;
        let auth = null;
        let db = null;
        let userId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug');
                console.log("Firebase initialized.");

                onAuthStateChanged(auth, (user) => {
                    const loadingState = document.getElementById('loading-state');
                    const mainContent = document.getElementById('main-content');
                    const loginContent = document.getElementById('login-content');
                    const logoutBtn = document.getElementById('logout-btn');
                    const userIdDisplay = document.getElementById('user-id');

                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        console.log("User authenticated:", userId);
                        loadingState.classList.add('hidden');
                        loginContent.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        logoutBtn.classList.remove('hidden');
                        setupDataListener();
                    } else {
                        console.log("No user signed in.");
                        loadingState.classList.add('hidden');
                        loginContent.classList.remove('hidden');
                        mainContent.classList.add('hidden');
                        logoutBtn.classList.add('hidden');
                    }
                });

                // Login with Google
                document.getElementById('login-btn').addEventListener('click', async () => {
                    const provider = new GoogleAuthProvider();
                    try {
                        await signInWithPopup(auth, provider);
                    } catch (error) {
                        console.error("Error signing in with Google:", error);
                    }
                });
                
                document.getElementById('logout-btn').addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                    } catch (error) {
                        console.error("Error signing out:", error);
                    }
                });

            } else {
                console.error("Firebase config is missing. The app cannot function without it.");
                document.getElementById('loading-state').innerHTML = `<p class="text-red-500 font-bold">Error: Firebase configuration is missing.</p>`;
                document.getElementById('loading-state').classList.remove('hidden');
            }
        });

        // Event listener for form submission
        document.getElementById('transaction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || !userId) {
                console.error("Firebase is not initialized or user is not authenticated.");
                return;
            }

            const formData = new FormData(e.target);
            const data = {
                timestamp: new Date(),
                date: formData.get('date'),
                channel: formData.get('channel'),
                order_number: formData.get('order_number'),
                buyer_name: formData.get('buyer_name'),
                driver_name: formData.get('driver_name'),
                item: formData.get('item'),
                order_list: formData.get('order_list'),
                income: parseFloat(formData.get('income')) || 0,
                gp_fee_excl_vat: parseFloat(formData.get('gp_fee_excl_vat')) || 0,
                shipping_discount_fee_excl_vat: parseFloat(formData.get('shipping_discount_fee_excl_vat')) || 0,
                vat_amount: parseFloat(formData.get('vat_amount')) || 0,
                raw_material_cost: parseFloat(formData.get('raw_material_cost')) || 0,
                expense: parseFloat(formData.get('expense')) || 0,
                note: formData.get('note'),
                userId: userId
            };

            try {
                const transactionDocRef = doc(db, `artifacts/${appId}/users/${userId}/data/summary`);
                await setDoc(transactionDocRef, data, { merge: true });
                console.log("Data saved successfully.");
            } catch (error) {
                console.error("Error saving document: ", error);
            }
        });

        // Listen for real-time data updates for a single document
        function setupDataListener() {
            if (!db || !userId) {
                console.error("Firebase is not initialized or user is not authenticated.");
                return;
            }

            const transactionDocRef = doc(db, `artifacts/${appId}/users/${userId}/data/summary`);
            
            onSnapshot(transactionDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    displayData(docSnap.data());
                } else {
                    console.log("No data found, starting with a blank form.");
                    // No need to clear form, it should start blank
                }
            }, (error) => {
                console.error("Error listening to document:", error);
            });
        }
        
        // Display data in the form and update summary
        function displayData(data) {
            document.getElementById('date').value = data.date || '';
            document.getElementById('channel').value = data.channel || '';
            document.getElementById('order_number').value = data.order_number || '';
            document.getElementById('buyer_name').value = data.buyer_name || '';
            document.getElementById('driver_name').value = data.driver_name || '';
            document.getElementById('item').value = data.item || '';
            document.getElementById('order_list').value = data.order_list || '';
            document.getElementById('income').value = (data.income || 0).toFixed(2);
            document.getElementById('gp_fee_excl_vat').value = (data.gp_fee_excl_vat || 0).toFixed(2);
            document.getElementById('shipping_discount_fee_excl_vat').value = (data.shipping_discount_fee_excl_vat || 0).toFixed(2);
            document.getElementById('vat_amount').value = (data.vat_amount || 0).toFixed(2);
            document.getElementById('raw_material_cost').value = (data.raw_material_cost || 0).toFixed(2);
            document.getElementById('expense').value = (data.expense || 0).toFixed(2);
            document.getElementById('note').value = data.note || '';

            const totalIncome = (data.income || 0);
            const totalExpense = (data.expense || 0) + (data.gp_fee_excl_vat || 0) + (data.shipping_discount_fee_excl_vat || 0) + (data.vat_amount || 0) + (data.raw_material_cost || 0);
            const totalProfit = totalIncome - totalExpense;

            document.getElementById('total-income').textContent = totalIncome.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('total-expense').textContent = totalExpense.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('total-profit').textContent = totalProfit.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('total-profit').classList.remove('text-teal-600', 'text-rose-600');
            document.getElementById('total-profit').classList.add(totalProfit >= 0 ? 'text-teal-600' : 'text-rose-600');
        }

        // Modal Logic
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');

        window.showModal = (title, message, confirmAction = null) => {
            modalTitle.textContent = title;
            modalBody.innerHTML = `<p>${message}</p>`;
            modalConfirm.onclick = () => {
                if (confirmAction) {
                    confirmAction();
                }
                modal.style.display = 'none';
            };
            modalCancel.onclick = () => {
                modal.style.display = 'none';
            };
            modal.style.display = 'flex';
        };

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };
    </script>
</head>

<body class="bg-gray-100 font-sans leading-normal tracking-normal">
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-800">บัญชีรายรับ-รายจ่าย เดลิเวอรี่</h1>
            <p class="text-lg text-gray-600 mt-2">สำหรับร้านโครตจะแมน</p>
        </header>

        <div id="loading-state" class="flex flex-col items-center justify-center min-h-[50vh]">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-gray-900 mx-auto"></div>
            <p class="mt-4 text-gray-600">กำลังเชื่อมต่อฐานข้อมูล...</p>
        </div>
        
        <div id="login-content" class="flex flex-col items-center justify-center min-h-[50vh] hidden">
            <div class="bg-white p-8 rounded-lg shadow-xl text-center">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">ยินดีต้อนรับ</h2>
                <p class="text-gray-600 mb-6">เข้าสู่ระบบด้วยบัญชี Google เพื่อเริ่มบันทึกข้อมูล</p>
                <button id="login-btn" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-md shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    เข้าสู่ระบบด้วย Google
                </button>
            </div>
        </div>

        <main id="main-content" class="hidden">
            <div class="flex justify-end mb-4">
                <button id="logout-btn" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-md shadow-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">ออกจากระบบ</button>
            </div>

            <section class="bg-white p-6 rounded-lg shadow-xl mb-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">สรุปยอดทั้งหมด</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="bg-teal-700 p-4 rounded-lg shadow-sm">
                        <p class="text-lg text-white">รายรับรวม</p>
                        <p class="text-3xl font-extrabold text-white mt-1">฿<span id="total-income">0.00</span></p>
                    </div>
                    <div class="bg-rose-700 p-4 rounded-lg shadow-sm">
                        <p class="text-lg text-white">รายจ่ายรวม</p>
                        <p class="text-3xl font-extrabold text-white mt-1">฿<span id="total-expense">0.00</span></p>
                    </div>
                    <div class="bg-teal-700 p-4 rounded-lg shadow-sm">
                        <p class="text-lg text-white">กำไร/ขาดทุน</p>
                        <p class="text-3xl font-extrabold text-white mt-1">฿<span id="total-profit">0.00</span></p>
                    </div>
                </div>
            </section>
            
            <section class="bg-white p-6 rounded-lg shadow-xl mb-8 border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">ฟอร์มบันทึกและแก้ไขข้อมูล</h2>
                <div class="bg-yellow-100 p-3 rounded-lg text-yellow-800 text-sm mb-4">
                    💡 User ID: <span id="user-id" class="font-mono break-all"></span>
                </div>
                <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="date" class="block text-sm font-medium text-gray-700 mb-1">วัน/เวลา</label>
                        <input type="datetime-local" id="date" name="date" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="channel" class="block text-sm font-medium text-gray-700 mb-1">ช่องทาง</label>
                        <select id="channel" name="channel" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                            <option value="">เลือกช่องทาง</option>
                            <option value="ShopeeFood">ShopeeFood</option>
                            <option value="Lineman">Lineman</option>
                            <option value="อื่นๆ">อื่นๆ</option>
                        </select>
                    </div>
                    <div>
                        <label for="order_number" class="block text-sm font-medium text-gray-700 mb-1">เลขออเดอร์</label>
                        <input type="text" id="order_number" name="order_number" placeholder="ใส่เลขออเดอร์"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="buyer_name" class="block text-sm font-medium text-gray-700 mb-1">ชื่อผู้ซื้อ</label>
                        <input type="text" id="buyer_name" name="buyer_name" placeholder="ชื่อผู้ซื้อ"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="driver_name" class="block text-sm font-medium text-gray-700 mb-1">คนขับ</label>
                        <input type="text" id="driver_name" name="driver_name" placeholder="ชื่อคนขับ"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="item" class="block text-sm font-medium text-gray-700 mb-1">รายการ</label>
                        <input type="text" id="item" name="item" placeholder="เช่น ก๋วยเตี๋ยว, ข้าวผัด"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div class="md:col-span-3">
                        <label for="order_list" class="block text-sm font-medium text-gray-700 mb-1">รายการสั่งซื้อ</label>
                        <textarea id="order_list" name="order_list" rows="3" placeholder="เช่น ก๋วยเตี๋ยว 1, ข้าวผัด 2, น้ำเปล่า 1"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400"></textarea>
                    </div>
                    <div>
                        <label for="income" class="block text-sm font-medium text-gray-700 mb-1">รายรับ</label>
                        <input type="number" id="income" name="income" step="0.01" value="0.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="gp_fee_excl_vat" class="block text-sm font-medium text-gray-700 mb-1">ค่าใช้จ่าย GP (ไม่รวม VAT)</label>
                        <input type="number" id="gp_fee_excl_vat" name="gp_fee_excl_vat" step="0.01" value="0.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="shipping_discount_fee_excl_vat" class="block text-sm font-medium text-gray-700 mb-1">ค่าส่วนลดค่าส่ง (ไม่รวม VAT)</label>
                        <input type="number" id="shipping_discount_fee_excl_vat" name="shipping_discount_fee_excl_vat" step="0.01" value="0.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="vat_amount" class="block text-sm font-medium text-gray-700 mb-1">ค่า VAT</label>
                        <input type="number" id="vat_amount" name="vat_amount" step="0.01" value="0.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="raw_material_cost" class="block text-sm font-medium text-gray-700 mb-1">ค่าวัตถุดิบ</label>
                        <input type="number" id="raw_material_cost" name="raw_material_cost" step="0.01" value="0.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div>
                        <label for="expense" class="block text-sm font-medium text-gray-700 mb-1">ค่าใช้จ่ายอื่นๆ</label>
                        <input type="number" id="expense" name="expense" step="0.01" value="0.00"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div class="md:col-span-3">
                        <label for="note" class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
                        <input type="text" id="note" name="note" placeholder="รายละเอียดเพิ่มเติม (ถ้ามี)"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring focus:ring-blue-200 focus:border-blue-400">
                    </div>
                    <div class="md:col-span-3 text-right">
                        <button type="submit"
                            class="mt-4 px-6 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            บันทึกรายการ
                        </button>
                    </div>
                </form>
            </section>
        </main>

        <!-- Modal for user interaction -->
        <div id="modal" class="modal">
            <div class="modal-content">
                <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
                <div id="modal-body" class="mb-4"></div>
                <div class="flex justify-center space-x-4">
                    <button id="modal-confirm" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">ยืนยัน</button>
                    <button id="modal-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">ยกเลิก</button>
                </div>
            </div>
        </div>

    </div>
</body>

</html>
