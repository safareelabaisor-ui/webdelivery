<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‡∏£‡πâ‡∏≤‡∏ô‡πÇ‡∏Ñ‡∏£‡∏ï‡∏à‡∏∞‡πÅ‡∏°‡∏ô</title>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS CDN for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.4);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #10B981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
        }

        .toast-notification.show {
            opacity: 1;
        }
    </style>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, query, where, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDN2AeIQDd4lOgFj3uW1DSSJHybfw0sl78",
            authDomain: "my-delivery-app-89237.firebaseapp.com",
            projectId: "my-delivery-app-89237",
            storageBucket: "my-delivery-app-89237.firebasestorage.app",
            messagingSenderId: "57996698405",
            appId: "1:57996698405:web:5f7efa6c439d24f0abf0cc",
            measurementId: "G-FM7S14RX3R"
        };
        const appId = "my-delivery-app-89237";
        
        // Initialize Firebase
        let app = null;
        let auth = null;
        let db = null;
        let userEmail = null; // Changed from userId
        let myChart = null;
        let myExpenseChart = null; // New chart instance for expenses
        let allTransactions = []; // Store all transactions here
        let filteredTransactions = []; // Store filtered transactions for display and export
        let allRecipes = [];
        let rawMaterialCosts = {}; // New object to store raw material costs
        
        // Discord Webhook URL (replace with your own)
        const DISCORD_WEBHOOK_URL = "https://discordapp.com/api/webhooks/1417426298954846289/6DOwlCNNYkcZsJILbFhKqAvX21tp_ZulqyJji6ErC5kR24CNWdv4X-_1ktGbMI5V4ZEp";

        document.addEventListener('DOMContentLoaded', async () => {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                setLogLevel('Debug');
                console.log("Firebase initialized.");

                onAuthStateChanged(auth, (user) => {
                    const loadingState = document.getElementById('loading-state');
                    const mainContent = document.getElementById('main-content');
                    const loginContent = document.getElementById('login-content');
                    const logoutBtn = document.getElementById('logout-btn');
                    const userIdDisplay = document.getElementById('user-id');

                    if (user) {
                        userEmail = user.email; // Get user email
                        userIdDisplay.textContent = userEmail;
                        console.log("User authenticated:", userEmail);
                        loadingState.classList.add('hidden');
                        loginContent.classList.add('hidden');
                        mainContent.classList.remove('hidden');
                        logoutBtn.classList.remove('hidden');
                        setupDataListeners();
                        setupInventoryListeners();
                        setupRecipeListeners();
                        populateMonthYearSelects();
                    } else {
                        console.log("No user signed in.");
                        loadingState.classList.add('hidden');
                        loginContent.classList.remove('hidden');
                        mainContent.classList.add('hidden');
                        logoutBtn.classList.add('hidden');
                    }
                });

                // Login with Google
                document.getElementById('login-btn').addEventListener('click', async () => {
                    const provider = new GoogleAuthProvider();
                    try {
                        await signInWithPopup(auth, provider);
                    } catch (error) {
                        console.error("Error signing in with Google:", error);
                    }
                });
                
                document.getElementById('logout-btn').addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                    } catch (error) {
                        console.error("Error signing out:", error);
                    }
                });

                // Set up event listeners for filters
                document.getElementById('search-query').addEventListener('input', applyFilters);
                document.getElementById('filter-channel').addEventListener('change', applyFilters);
                document.getElementById('filter-start-date').addEventListener('change', applyFilters);
                document.getElementById('filter-end-date').addEventListener('change', applyFilters);
                document.getElementById('reset-filters-btn').addEventListener('click', resetFilters);
                document.getElementById('export-csv-btn').addEventListener('click', () => exportToCSV(filteredTransactions));
                document.getElementById('export-excel-btn').addEventListener('click', () => exportToExcel(filteredTransactions));


            } else {
                console.error("Firebase config is missing. The app cannot function without it.");
                document.getElementById('loading-state').innerHTML = `<p class="text-red-500 font-bold">Error: Firebase configuration is missing.</p>`;
                document.getElementById('loading-state').classList.remove('hidden');
            }
        });

        function showToastNotification(message, isSuccess = true) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.remove('bg-red-500', 'bg-green-500');
            toast.classList.add(isSuccess ? 'bg-green-500' : 'bg-red-500');
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // A single function to send messages to Discord
        async function sendDiscordMessage(message, embed = null) {
            if (DISCORD_WEBHOOK_URL === "https://discord.com/api/webhooks/1234567890/abcdefghijklmnopqrstuvwxyz") {
                console.warn("Discord Webhook URL not set. Skipping notification.");
                return;
            }

            const payload = {
                content: message,
                username: "Accounting Bot",
                avatar_url: "https://placehold.co/60x60/34D399/FFFFFF?text=ü§ñ"
            };

            if (embed) {
                payload.embeds = [embed];
            }

            try {
                const response = await fetch(DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.ok) {
                    console.log("Discord notification sent successfully.");
                } else {
                    console.error("Failed to send Discord notification:", response.status, response.statusText);
                }
            } catch (error) {
                console.error("Error sending Discord notification:", error);
            }
        }

        // Event listener for form submission
        document.getElementById('transaction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || !userEmail) {
                console.error("Firebase is not initialized or user is not authenticated.");
                return;
            }

            const formData = new FormData(e.target);
            const data = {
                timestamp: new Date(),
                date: formData.get('date'),
                item: formData.get('item'),
                order_list: formData.get('order_list'),
                channel: formData.get('channel'),
                income: parseFloat(formData.get('income')) || 0,
                gp_fee_excl_vat: parseFloat(formData.get('gp_fee_excl_vat')) || 0,
                shipping_discount_fee_excl_vat: parseFloat(formData.get('shipping_discount_fee_excl_vat')) || 0,
                vat_amount: parseFloat(formData.get('vat_amount')) || 0,
                raw_material_cost: parseFloat(formData.get('raw_material_cost')) || 0,
                expense: parseFloat(formData.get('expense')) || 0,
                note: formData.get('note'),
                buyer_name: formData.get('buyer_name'),
                order_id: formData.get('order_id'),
                order_number: formData.get('order_number'),
                driver_name: formData.get('driver_name'),
                recordedByUserEmail: userEmail // Add the user email
            };

            try {
                const transactionsColRef = collection(db, `artifacts/${appId}/public/data/transactions`);
                await addDoc(transactionsColRef, data);
                e.target.reset(); // Clear form after successful submission
                console.log("Transaction added successfully.");
                showToastNotification("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                updateInventoryOnSale(data);
                
                const transactionMessage = `‚úÖ **‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:** ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ${data.income.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏à‡∏≤‡∏Å ${data.channel}. ‡πÇ‡∏î‡∏¢ ${userEmail}`;
                sendDiscordMessage(transactionMessage);

            } catch (error) {
                console.error("Error adding document: ", error);
            }
        });

        // Inventory management form submission
        document.getElementById('inventory-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || !userEmail) {
                console.error("Firebase is not initialized or user is not authenticated.");
                return;
            }
            
            const formData = new FormData(e.target);
            const data = {
                name: formData.get('inventory-name'),
                unit: formData.get('inventory-unit'),
                current_stock: parseFloat(formData.get('inventory-stock')) || 0,
                low_threshold: parseFloat(formData.get('inventory-threshold')) || 0,
            };

            try {
                const inventoryDocRef = doc(db, `artifacts/${appId}/public/data/inventory`, data.name);
                await setDoc(inventoryDocRef, data);
                e.target.reset();
                console.log("Inventory item added/updated successfully.");
                showToastNotification("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                const inventoryMessage = `üì¶ **‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï:** ${data.name} ‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà ${data.current_stock} ${data.unit}. ‡πÇ‡∏î‡∏¢ ${userEmail}`;
                sendDiscordMessage(inventoryMessage);
            } catch (error) {
                console.error("Error adding/updating inventory item: ", error);
            }
        });

        // Raw material cost management form submission
        document.getElementById('raw-material-cost-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || !userEmail) {
                console.error("Firebase is not initialized or user is not authenticated.");
                return;
            }

            const formData = new FormData(e.target);
            const data = {
                name: formData.get('cost-item-name'),
                cost_per_unit: parseFloat(formData.get('cost-per-unit')) || 0,
                unit: formData.get('cost-unit'),
            };
            
            try {
                const costDocRef = doc(db, `artifacts/${appId}/public/data/rawMaterialCosts`, data.name);
                await setDoc(costDocRef, data);
                e.target.reset();
                console.log("Raw material cost added/updated successfully.");
                showToastNotification("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            } catch (error) {
                console.error("Error adding/updating raw material cost:", error);
            }
        });

        // Update inventory after a sale (Deduct raw materials)
        async function updateInventoryOnSale(transactionData) {
            if (!db || !userEmail || allRecipes.length === 0) {
                console.log("Recipes not loaded or user not authenticated. Skipping inventory deduction.");
                return;
            }
            
            const orderList = transactionData.order_list.toLowerCase();
            const inventoryColRef = collection(db, `artifacts/${appId}/public/data/inventory`);
            
            allRecipes.forEach(async (recipe) => {
                // Check if the finished product is in the order list
                if (orderList.includes(recipe.finished_product.toLowerCase())) {
                    console.log(`Matching recipe found for: ${recipe.finished_product}`);
                    const inventorySnapshot = await getDocs(inventoryColRef);
                    const inventoryItems = {};
                    inventorySnapshot.forEach(doc => {
                        inventoryItems[doc.data().name.toLowerCase()] = { id: doc.id, ...doc.data() };
                    });

                    // Deduct each raw material from the recipe
                    recipe.raw_materials.forEach(async (rawMaterial) => {
                        const materialNameLower = rawMaterial.name.toLowerCase();
                        if (inventoryItems[materialNameLower]) {
                            const currentStock = inventoryItems[materialNameLower].current_stock || 0;
                            const newStock = currentStock - (rawMaterial.quantity || 0);
                            
                            const inventoryRef = doc(db, `artifacts/${appId}/public/data/inventory`, inventoryItems[materialNameLower].id);
                            await updateDoc(inventoryRef, { current_stock: newStock });
                            console.log(`Deducted ${rawMaterial.quantity} ${rawMaterial.unit} of ${rawMaterial.name}. New stock: ${newStock}`);
                        } else {
                            console.warn(`Raw material "${rawMaterial.name}" not found in inventory.`);
                        }
                    });
                }
            });

            // Re-check low stock after every sale
            const inventorySnapshot = await getDocs(inventoryColRef);
            const updatedItems = [];
            inventorySnapshot.forEach(doc => {
                updatedItems.push({ id: doc.id, ...doc.data() });
            });
            checkLowStock(updatedItems);
        }
        
        // Listen for real-time inventory updates
        function setupInventoryListeners() {
            if (!db || !userEmail) {
                console.error("Firebase is not initialized or user is not authenticated.");
                return;
            }
            const inventoryColRef = collection(db, `artifacts/${appId}/public/data/inventory`);
            onSnapshot(inventoryColRef, (querySnapshot) => {
                const inventoryItems = [];
                querySnapshot.forEach((doc) => {
                    inventoryItems.push({ id: doc.id, ...doc.data() });
                });
                displayInventory(inventoryItems);
                checkLowStock(inventoryItems); // Check low stock when inventory changes
            });
        }
        
        // Listen for real-time raw material cost updates
        function setupRawMaterialCostListeners() {
            if (!db || !userEmail) return;
            const costColRef = collection(db, `artifacts/${appId}/public/data/rawMaterialCosts`);
            onSnapshot(costColRef, (querySnapshot) => {
                rawMaterialCosts = {};
                const costs = [];
                querySnapshot.forEach(doc => {
                    const costData = { id: doc.id, ...doc.data() };
                    rawMaterialCosts[doc.id] = costData;
                    costs.push(costData);
                });
                displayRawMaterialCosts(costs);
            });
        }

        // Check for low stock and send notification
        function checkLowStock(inventoryItems) {
            const lowStockItems = inventoryItems.filter(item => item.current_stock <= item.low_threshold);
            const lowStockAlert = document.getElementById('low-stock-alert');
            
            if (lowStockItems.length > 0) {
                const messages = lowStockItems.map(item => `‚ö†Ô∏è **${item.name}** ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß! ‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${item.current_stock} ${item.unit} (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå ${item.low_threshold} ${item.unit})`);
                lowStockAlert.innerHTML = messages.join('<br>');
                lowStockAlert.classList.remove('hidden');
                sendDiscordMessage(messages.join('\n'));
            } else {
                lowStockAlert.classList.add('hidden');
            }
        }

        function displayInventory(items) {
            const tableBody = document.getElementById('inventory-table-body');
            tableBody.innerHTML = '';
            if (items.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á</td></tr>`;
            }
            items.forEach(item => {
                const statusColor = item.current_stock <= item.low_threshold ? 'text-rose-600 font-bold' : 'text-emerald-600';
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'text-gray-700', 'text-sm');
                row.innerHTML = `
                    <td class="px-4 py-2 border-b">${item.name}</td>
                    <td class="px-4 py-2 border-b">${item.unit}</td>
                    <td class="px-4 py-2 border-b text-right ${statusColor}">${item.current_stock.toLocaleString()}</td>
                    <td class="px-4 py-2 border-b text-right">${item.low_threshold.toLocaleString()}</td>
                    <td class="px-4 py-2 border-b text-center space-x-2">
                        <button onclick="window.showEditInventoryModal('${item.id}', '${item.name}', '${item.unit}', ${item.current_stock}, ${item.low_threshold})" class="text-blue-500 hover:text-blue-700 font-medium">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button onclick="window.showDeleteInventoryModal('${item.id}')" class="text-red-500 hover:text-red-700 font-medium">‡∏•‡∏ö</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function displayRawMaterialCosts(costs) {
            const tableBody = document.getElementById('raw-material-cost-table-body');
            tableBody.innerHTML = '';
            if (costs.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</td></tr>`;
            }
            costs.forEach(cost => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'text-gray-700', 'text-sm');
                row.innerHTML = `
                    <td class="px-4 py-2 border-b">${cost.name}</td>
                    <td class="px-4 py-2 border-b">${cost.unit}</td>
                    <td class="px-4 py-2 border-b text-right">${(cost.cost_per_unit || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-4 py-2 border-b text-center space-x-2">
                        <button onclick="window.showEditRawMaterialCostModal('${cost.id}', '${cost.name}', '${cost.unit}', ${cost.cost_per_unit})" class="text-blue-500 hover:text-blue-700 font-medium">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button onclick="window.showDeleteRawMaterialCostModal('${cost.id}')" class="text-red-500 hover:text-red-700 font-medium">‡∏•‡∏ö</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Listen for real-time data updates
        function setupDataListeners() {
            if (!db || !userEmail) {
                console.error("Firebase is not initialized or user is not authenticated.");
                return;
            }

            const transactionsColRef = collection(db, `artifacts/${appId}/public/data/transactions`);
            const q = query(transactionsColRef);

            onSnapshot(q, (querySnapshot) => {
                allTransactions = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    allTransactions.push({ id: doc.id, ...data, timestamp: data.timestamp ? data.timestamp.toDate() : new Date() });
                });

                // Sort transactions by date and timestamp in memory
                allTransactions.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    if (dateA - dateB !== 0) {
                        return dateA - dateB;
                    }
                    return a.timestamp - b.timestamp;
                });
                
                applyFilters();
            }, (error) => {
                console.error("Error listening to transactions:", error);
            });
        }
        
        // Apply filters to transactions
        function applyFilters() {
            const searchQuery = document.getElementById('search-query').value.toLowerCase();
            const filterChannel = document.getElementById('filter-channel').value;
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            
            filteredTransactions = allTransactions.filter(transaction => {
                const searchMatch = !searchQuery || (
                    (transaction.order_number && transaction.order_number.toLowerCase().includes(searchQuery)) ||
                    (transaction.buyer_name && transaction.buyer_name.toLowerCase().includes(searchQuery)) ||
                    (transaction.item && transaction.item.toLowerCase().includes(searchQuery)) ||
                    (transaction.order_list && transaction.order_list.toLowerCase().includes(searchQuery)) ||
                    (transaction.note && transaction.note.toLowerCase().includes(searchQuery))
                );

                const channelMatch = !filterChannel || transaction.channel === filterChannel;

                const dateMatch = (!startDate || new Date(transaction.date) >= new Date(startDate)) &&
                                 (!endDate || new Date(transaction.date) <= new Date(endDate + 'T23:59:59'));
                
                return searchMatch && channelMatch && dateMatch;
            });
            
            displayTransactions(filteredTransactions);
            updateMonthlySummary(filteredTransactions);
            updateChart(filteredTransactions);
            updateExpenseChart(filteredTransactions);
        }

        // Reset all filters
        function resetFilters() {
            document.getElementById('search-query').value = '';
            document.getElementById('filter-channel').value = '';
            document.getElementById('filter-start-date').value = '';
            document.getElementById('filter-end-date').value = '';
            applyFilters();
        }

        // Export data to CSV
        function exportToCSV(data) {
            if (data.length === 0) {
                console.warn("No data to export.");
                return;
            }

            const header = [
                "‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤", "‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", "‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå", "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠", "‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠", 
                "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (‡∏ö‡∏≤‡∏ó)", "‡∏Ñ‡πà‡∏≤ GP (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° VAT)", "‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° VAT)", "‡∏Ñ‡πà‡∏≤ VAT", 
                "‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (‡∏ö‡∏≤‡∏ó)", "‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ö‡∏≤‡∏ó)", "‡∏Å‡∏≥‡πÑ‡∏£ (‡∏ö‡∏≤‡∏ó)", "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏", "‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏≠‡∏µ‡πÄ‡∏°‡∏•)"
            ].join(',');
            
            const csvRows = data.map(transaction => {
                const profit = (transaction.income || 0) - ((transaction.expense || 0) + (transaction.gp_fee_excl_vat || 0) + (transaction.shipping_discount_fee_excl_vat || 0) + (transaction.vat_amount || 0) + (transaction.raw_material_cost || 0));
                
                const escapeCSV = (value) => {
                    if (value === null || value === undefined) return '';
                    let str = String(value);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return `"${str.replace(/"/g, '""')}"`;
                    }
                    return str;
                };

                return [
                    escapeCSV(transaction.date.split('T')[0]),
                    escapeCSV(transaction.channel || ''),
                    escapeCSV(transaction.order_number || ''),
                    escapeCSV(transaction.buyer_name || ''),
                    escapeCSV(transaction.driver_name || ''),
                    escapeCSV(transaction.item || ''),
                    escapeCSV(transaction.order_list || ''),
                    escapeCSV(transaction.income || 0),
                    escapeCSV(transaction.gp_fee_excl_vat || 0),
                    escapeCSV(transaction.shipping_discount_fee_excl_vat || 0),
                    escapeCSV(transaction.vat_amount || 0),
                    escapeCSV(transaction.raw_material_cost || 0),
                    escapeCSV(transaction.expense || 0),
                    escapeCSV(profit),
                    escapeCSV(transaction.note || ''),
                    escapeCSV(transaction.recordedByUserEmail || '')
                ].join(',');
            });
            const BOM = "\uFEFF"; // Byte Order Mark
            const csvString = [BOM + header, ...csvRows].join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'delivery_transactions.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            console.log("Exported to CSV successfully.");
        }

        // Export data to Excel
        function exportToExcel(data) {
            if (data.length === 0) {
                console.warn("No data to export.");
                return;
            }

            const header = [
                "‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤", "‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á", "‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå", "‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠", "‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£", "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠", 
                "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (‡∏ö‡∏≤‡∏ó)", "‡∏Ñ‡πà‡∏≤ GP (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° VAT)", "‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° VAT)", "‡∏Ñ‡πà‡∏≤ VAT", 
                "‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (‡∏ö‡∏≤‡∏ó)", "‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ö‡∏≤‡∏ó)", "‡∏Å‡∏≥‡πÑ‡∏£ (‡∏ö‡∏≤‡∏ó)", "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏", "‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏≠‡∏µ‡πÄ‡∏°‡∏•)"
            ];

            const excelRows = data.map(transaction => {
                const profit = (transaction.income || 0) - ((transaction.expense || 0) + (transaction.gp_fee_excl_vat || 0) + (transaction.shipping_discount_fee_excl_vat || 0) + (transaction.vat_amount || 0) + (transaction.raw_material_cost || 0));
                
                return [
                    transaction.date.split('T')[0],
                    transaction.channel || '',
                    transaction.order_number || '',
                    transaction.buyer_name || '',
                    transaction.driver_name || '',
                    transaction.item || '',
                    transaction.order_list || '',
                    (transaction.income || 0),
                    (transaction.gp_fee_excl_vat || 0),
                    (transaction.shipping_discount_fee_excl_vat || 0),
                    (transaction.vat_amount || 0),
                    (transaction.raw_material_cost || 0),
                    (transaction.expense || 0),
                    profit,
                    transaction.note || '',
                    transaction.recordedByUserEmail || ''
                ];
            });

            const ws = XLSX.utils.aoa_to_sheet([header, ...excelRows]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Transactions");
            XLSX.writeFile(wb, "delivery_transactions.xlsx");
            console.log("Exported to Excel successfully.");
        }

        // Populate month and year dropdowns
        function populateMonthYearSelects() {
            const months = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
            const monthSelect = document.getElementById('summary-month');
            const yearSelect = document.getElementById('summary-year');
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();

            monthSelect.innerHTML = '';
            yearSelect.innerHTML = '';

            for (let i = 0; i < months.length; i++) {
                const option = document.createElement('option');
                option.value = i + 1;
                option.textContent = months[i];
                if (i === currentMonth) {
                    option.selected = true;
                }
                monthSelect.appendChild(option);
            }

            for (let i = currentYear - 5; i <= currentYear; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                if (i === currentYear) {
                    option.selected = true;
                }
                yearSelect.appendChild(option);
            }

            monthSelect.addEventListener('change', () => applyFilters());
            yearSelect.addEventListener('change', () => applyFilters());
        }
        
        // Update monthly summary
        function updateMonthlySummary(transactions = []) {
            const selectedMonth = parseInt(document.getElementById('summary-month').value);
            const selectedYear = parseInt(document.getElementById('summary-year').value);

            let monthlyIncome = 0;
            let monthlyExpense = 0;

            transactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                const totalTransactionExpense = (transaction.expense || 0) + (transaction.gp_fee_excl_vat || 0) + (transaction.shipping_discount_fee_excl_vat || 0) + (transaction.vat_amount || 0) + (transaction.raw_material_cost || 0);

                if (transactionDate.getMonth() + 1 === selectedMonth && transactionDate.getFullYear() === selectedYear) {
                    monthlyIncome += (transaction.income || 0);
                    monthlyExpense += totalTransactionExpense;
                }
            });

            document.getElementById('monthly-income').textContent = monthlyIncome.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('monthly-expense').textContent = monthlyExpense.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const monthlyProfit = monthlyIncome - monthlyExpense;
            document.getElementById('monthly-profit').textContent = monthlyProfit.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            document.getElementById('monthly-profit').classList.remove('text-emerald-600', 'text-rose-600');
            document.getElementById('monthly-profit').classList.add(monthlyProfit >= 0 ? 'text-emerald-600' : 'text-rose-600');
        }

        // Update the income chart
        function updateChart(transactions = []) {
            const channelData = transactions.reduce((acc, transaction) => {
                const channel = transaction.channel || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                acc[channel] = (acc[channel] || 0) + (transaction.income || 0);
                return acc;
            }, {});

            const labels = Object.keys(channelData);
            const data = Object.values(channelData);
            const backgroundColors = [
                'rgb(16, 185, 129)',  // Emerald-500
                'rgb(99, 102, 241)',  // Indigo-500
                'rgb(244, 63, 94)',   // Rose-500
                'rgb(245, 158, 11)',  // Amber-500
                'rgb(59, 130, 246)'   // Blue-500
            ];

            const chartData = {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    hoverOffset: 4
                }]
            };

            if (myChart) {
                myChart.data = chartData;
                myChart.update();
            } else {
                const ctx = document.getElementById('myChart').getContext('2d');
                myChart = new Chart(ctx, {
                    type: 'pie',
                    data: chartData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                        const percentage = ((value / total) * 100).toFixed(2);
                                        return `${label}: ${value.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // New function to update the expense chart
        function updateExpenseChart(transactions = []) {
            const expenseData = transactions.reduce((acc, transaction) => {
                acc['‡∏Ñ‡πà‡∏≤ GP'] = (acc['‡∏Ñ‡πà‡∏≤ GP'] || 0) + (transaction.gp_fee_excl_vat || 0);
                acc['‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á'] = (acc['‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á'] || 0) + (transaction.shipping_discount_fee_excl_vat || 0);
                acc['‡∏Ñ‡πà‡∏≤ VAT'] = (acc['‡∏Ñ‡πà‡∏≤ VAT'] || 0) + (transaction.vat_amount || 0);
                acc['‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö'] = (acc['‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö'] || 0) + (transaction.raw_material_cost || 0);
                acc['‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ'] = (acc['‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ'] || 0) + (transaction.expense || 0);
                return acc;
            }, {});

            const labels = Object.keys(expenseData);
            const data = Object.values(expenseData);
            const backgroundColors = [
                'rgb(255, 99, 132)',  // Red
                'rgb(255, 159, 64)',  // Orange
                'rgb(255, 205, 86)',  // Yellow
                'rgb(75, 192, 192)',  // Green
                'rgb(54, 162, 235)'   // Blue
            ];

            const chartData = {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    hoverOffset: 4
                }]
            };

            if (myExpenseChart) {
                myExpenseChart.data = chartData;
                myExpenseChart.update();
            } else {
                const ctx = document.getElementById('myExpenseChart').getContext('2d');
                myExpenseChart = new Chart(ctx, {
                    type: 'pie',
                    data: chartData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((sum, current) => sum + current, 0);
                                        const percentage = ((value / total) * 100).toFixed(2);
                                        return `${label}: ${value.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‡∏ö‡∏≤‡∏ó (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Display transactions in the table and update summary
        function displayTransactions(transactions) {
            const tableBody = document.getElementById('transaction-table-body');
            const totalIncomeEl = document.getElementById('total-income');
            const totalExpenseEl = document.getElementById('total-expense');
            const totalProfitEl = document.getElementById('total-profit');

            tableBody.innerHTML = '';
            let totalIncome = 0;
            let totalExpense = 0;

            if (transactions.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="17" class="text-center py-4 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</td></tr>`;
            }

            transactions.forEach(transaction => {
                const totalTransactionExpense = (transaction.expense || 0) + (transaction.gp_fee_excl_vat || 0) + (transaction.shipping_discount_fee_excl_vat || 0) + (transaction.vat_amount || 0) + (transaction.raw_material_cost || 0);
                totalIncome += (transaction.income || 0);
                totalExpense += totalTransactionExpense;

                const profit = (transaction.income || 0) - totalTransactionExpense;
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'text-gray-700', 'text-sm');
                const transactionData = {
                    id: transaction.id,
                    note: transaction.note || '',
                    buyer_name: transaction.buyer_name || '',
                    order_id: transaction.order_id || '',
                    order_number: transaction.order_number || '',
                    driver_name: transaction.driver_name || '',
                    income: transaction.income || 0,
                    gp_fee_excl_vat: transaction.gp_fee_excl_vat || 0,
                    shipping_discount_fee_excl_vat: transaction.shipping_discount_fee_excl_vat || 0,
                    expense: transaction.expense || 0,
                    order_list: transaction.order_list || '',
                    vat_amount: transaction.vat_amount || 0,
                    raw_material_cost: transaction.raw_material_cost || 0,
                    recordedByUserEmail: transaction.recordedByUserEmail || ''
                };
                row.innerHTML = `
                    <td class="px-4 py-2 border-b whitespace-nowrap">${transaction.date.split('T')[0]}</td>
                    <td class="px-4 py-2 border-b">${transaction.channel || ''}</td>
                    <td class="px-4 py-2 border-b">${transaction.order_number || ''}</td>
                    <td class="px-4 py-2 border-b">${transaction.buyer_name || ''}</td>
                    <td class="px-4 py-2 border-b">${transaction.driver_name || ''}</td>
                    <td class="px-4 py-2 border-b">${transaction.item || ''}</td>
                    <td class="px-4 py-2 border-b">${transaction.order_list || ''}</td>
                    <td class="px-4 py-2 border-b text-right">${(transaction.income || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-4 py-2 border-b text-right">${(transaction.gp_fee_excl_vat || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-4 py-2 border-b text-right">${(transaction.shipping_discount_fee_excl_vat || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-4 py-2 border-b text-right">${(transaction.vat_amount || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-4 py-2 border-b text-right">${(transaction.raw_material_cost || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-4 py-2 border-b text-right">${(transaction.expense || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-4 py-2 border-b text-right ${profit >= 0 ? 'text-teal-600' : 'text-rose-600'}">${profit.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                    <td class="px-4 py-2 border-b">${transaction.note || ''}</td>
                    <td class="px-4 py-2 border-b text-sm font-mono whitespace-nowrap">${transaction.recordedByUserEmail || ''}</td>
                    <td class="px-4 py-2 border-b text-center space-x-2 whitespace-nowrap">
                        <button onclick='window.showEditModal(${JSON.stringify(transactionData)})' class="text-blue-500 hover:text-blue-700 font-medium">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button onclick="window.showDeleteModal('${transaction.id}')" class="text-red-500 hover:text-red-700 font-medium">‡∏•‡∏ö</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });

            totalIncomeEl.textContent = totalIncome.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            totalExpenseEl.textContent = totalExpense.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            totalProfitEl.textContent = (totalIncome - totalExpense).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            totalProfitEl.classList.remove('text-teal-600', 'text-rose-600');
            totalProfitEl.classList.add((totalIncome - totalExpense) >= 0 ? 'text-teal-600' : 'text-rose-600');
        }

        // Modal Logic
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalConfirm = document.getElementById('modal-confirm');
        const modalCancel = document.getElementById('modal-cancel');

        window.showEditModal = (transactionData) => {
            modalTitle.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
            modalBody.innerHTML = `
                <div class="space-y-4 text-left">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</label>
                        <input type="text" id="modal-buyer-name" value="${transactionData.buyer_name}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</label>
                        <input type="text" id="modal-order-id" value="${transactionData.order_id}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</label>
                        <input type="text" id="modal-order-number" value="${transactionData.order_number}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</label>
                        <input type="text" id="modal-driver-name" value="${transactionData.driver_name}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</label>
                        <textarea id="modal-order-list" class="w-full px-3 py-2 border border-gray-300 rounded-md">${transactionData.order_list}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</label>
                        <input type="number" id="modal-income" value="${transactionData.income}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ GP (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° VAT)</label>
                        <input type="number" id="modal-gp-fee-excl-vat" value="${transactionData.gp_fee_excl_vat}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° VAT)</label>
                        <input type="number" id="modal-shipping-discount-fee-excl-vat" value="${transactionData.shipping_discount_fee_excl_vat}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πà‡∏≤ VAT</label>
                        <input type="number" id="modal-vat-amount" value="${transactionData.vat_amount}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label>
                        <input type="number" id="modal-raw-material-cost" value="${transactionData.raw_material_cost}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                        <input type="number" id="modal-expense" value="${transactionData.expense}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <input type="text" id="modal-note" value="${transactionData.note}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>
            `;
            modalConfirm.onclick = () => {
                const newIncome = parseFloat(document.getElementById('modal-income').value);
                const newGpFeeExclVat = parseFloat(document.getElementById('modal-gp-fee-excl-vat').value);
                const newShippingDiscountFeeExclVat = parseFloat(document.getElementById('modal-shipping-discount-fee-excl-vat').value);
                const newVatAmount = parseFloat(document.getElementById('modal-vat-amount').value);
                const newRawMaterialCost = parseFloat(document.getElementById('modal-raw-material-cost').value);
                const newExpense = parseFloat(document.getElementById('modal-expense').value);
                const newNote = document.getElementById('modal-note').value;
                const newBuyerName = document.getElementById('modal-buyer-name').value;
                const newOrderNumber = document.getElementById('modal-order-number').value;
                const newDriverName = document.getElementById('modal-driver-name').value;
                const newOrderList = document.getElementById('modal-order-list').value;
                editTransaction(transactionData.id, newIncome, newGpFeeExclVat, newShippingDiscountFeeExclVat, newVatAmount, newRawMaterialCost, newExpense, newNote, newBuyerName, newOrderNumber, newDriverName, newOrderList);
                modal.style.display = 'none';
            };
            modalCancel.onclick = () => {
                modal.style.display = 'none';
            };
            modal.style.display = 'flex';
        };

        window.showDeleteModal = (id) => {
            modalTitle.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö';
            modalBody.innerHTML = `<p>‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?</p>`;
            modalConfirm.onclick = () => {
                deleteTransaction(id);
                modal.style.display = 'none';
            };
            modalCancel.onclick = () => {
                modal.style.display = 'none';
            };
            modal.style.display = 'flex';
        };

        async function editTransaction(id, newIncome, newGpFeeExclVat, newShippingDiscountFeeExclVat, newVatAmount, newRawMaterialCost, newExpense, newNote, newBuyerName, newOrderNumber, newDriverName, newOrderList) {
            if (!db || !userEmail) return;
            try {
                const transactionRef = doc(db, `artifacts/${appId}/public/data/transactions`, id);
                await updateDoc(transactionRef, { 
                    income: newIncome, 
                    gp_fee_excl_vat: newGpFeeExclVat, 
                    shipping_discount_fee_excl_vat: newShippingDiscountFeeExclVat, 
                    vat_amount: newVatAmount,
                    raw_material_cost: newRawMaterialCost,
                    expense: newExpense, 
                    note: newNote,
                    buyer_name: newBuyerName,
                    order_number: newOrderNumber,
                    driver_name: newDriverName,
                    order_list: newOrderList,
                    recordedByUserEmail: userEmail // Add the user email
                });
                console.log("Transaction updated successfully.");
                showToastNotification("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                const transactionMessage = `‚úèÔ∏è **‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:** ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${newOrderNumber} ‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ. ‡πÇ‡∏î‡∏¢ ${userEmail}`;
                sendDiscordMessage(transactionMessage);
            } catch (error) {
                console.error("Error updating document:", error);
            }
        }

        async function deleteTransaction(id) {
            if (!db || !userEmail) return;
            try {
                const transactionRef = doc(db, `artifacts/${appId}/public/data/transactions`, id);
                await deleteDoc(transactionRef);
                console.log("Transaction deleted successfully.");
                showToastNotification("üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                const transactionMessage = `üóëÔ∏è **‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏•‡∏ö:** ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${id} ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö. ‡πÇ‡∏î‡∏¢ ${userEmail}`;
                sendDiscordMessage(transactionMessage);
            } catch (error) {
                console.error("Error deleting document:", error);
            }
        }
        
        // Modal functions for inventory
        window.showEditInventoryModal = (id, name, unit, current_stock, low_threshold) => {
            modalTitle.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å';
            modalBody.innerHTML = `
                <div class="space-y-4 text-left">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label>
                        <input type="text" id="modal-inventory-name" value="${name}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</label>
                        <input type="text" id="modal-inventory-unit" value="${unit}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                        <input type="number" id="modal-inventory-stock" value="${current_stock}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</label>
                        <input type="number" id="modal-inventory-threshold" value="${low_threshold}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>
            `;
            modalConfirm.onclick = () => {
                const newName = document.getElementById('modal-inventory-name').value;
                const newUnit = document.getElementById('modal-inventory-unit').value;
                const newStock = parseFloat(document.getElementById('modal-inventory-stock').value);
                const newThreshold = parseFloat(document.getElementById('modal-inventory-threshold').value);
                editInventory(id, newName, newUnit, newStock, newThreshold);
                modal.style.display = 'none';
            };
            modalCancel.onclick = () => {
                modal.style.display = 'none';
            };
            modal.style.display = 'flex';
        };

        window.showDeleteInventoryModal = (id) => {
            modalTitle.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å';
            modalBody.innerHTML = `<p>‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ô‡∏µ‡πâ?</p>`;
            modalConfirm.onclick = () => {
                deleteInventory(id);
                modal.style.display = 'none';
            };
            modalCancel.onclick = () => {
                modal.style.display = 'none';
            };
            modal.style.display = 'flex';
        };

        async function editInventory(id, name, unit, current_stock, low_threshold) {
            if (!db || !userEmail) return;
            try {
                const inventoryRef = doc(db, `artifacts/${appId}/public/data/inventory`, id);
                await updateDoc(inventoryRef, { name, unit, current_stock, low_threshold });
                console.log("Inventory item updated successfully.");
                showToastNotification("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                const inventoryMessage = `‚úèÔ∏è **‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:** ${name} ‡∏°‡∏µ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà ${current_stock} ${unit}. ‡πÇ‡∏î‡∏¢ ${userEmail}`;
                sendDiscordMessage(inventoryMessage);
            } catch (error) {
                console.error("Error updating inventory document:", error);
            }
        }
        
        async function deleteInventory(id) {
            if (!db || !userEmail) return;
            try {
                const inventoryRef = doc(db, `artifacts/${appId}/public/data/inventory`, id);
                await deleteDoc(inventoryRef);
                console.log("Inventory item deleted successfully.");
                showToastNotification("üóëÔ∏è ‡∏•‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                const deleteMessage = `üóëÔ∏è **‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ñ‡∏π‡∏Å‡∏•‡∏ö:** ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ${id} ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö. ‡πÇ‡∏î‡∏¢ ${userEmail}`;
                sendDiscordMessage(deleteMessage);
            } catch (error) {
                console.error("Error deleting inventory document:", error);
            }
        }

        // Modal functions for raw material costs
        window.showEditRawMaterialCostModal = (id, name, unit, cost_per_unit) => {
            modalTitle.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö';
            modalBody.innerHTML = `
                <div class="space-y-4 text-left">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label>
                        <input type="text" id="modal-cost-item-name" value="${name}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</label>
                        <input type="text" id="modal-cost-unit" value="${unit}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="modal-cost-per-unit" value="${cost_per_unit}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                </div>
            `;
            modalConfirm.onclick = () => {
                const newName = document.getElementById('modal-cost-item-name').value;
                const newUnit = document.getElementById('modal-cost-unit').value;
                const newCost = parseFloat(document.getElementById('modal-cost-per-unit').value);
                editRawMaterialCost(id, newName, newUnit, newCost);
                modal.style.display = 'none';
            };
            modalCancel.onclick = () => { modal.style.display = 'none'; };
            modal.style.display = 'flex';
        };

        window.showDeleteRawMaterialCostModal = (id) => {
            modalTitle.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö';
            modalBody.innerHTML = `<p>‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏ô‡∏µ‡πâ?</p>`;
            modalConfirm.onclick = () => {
                deleteRawMaterialCost(id);
                modal.style.display = 'none';
            };
            modalCancel.onclick = () => { modal.style.display = 'none'; };
            modal.style.display = 'flex';
        };

        async function editRawMaterialCost(id, name, unit, cost_per_unit) {
            if (!db || !userEmail) return;
            try {
                const costRef = doc(db, `artifacts/${appId}/public/data/rawMaterialCosts`, id);
                await updateDoc(costRef, { name, unit, cost_per_unit });
                showToastNotification("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            } catch (error) {
                console.error("Error updating raw material cost:", error);
            }
        }
        
        async function deleteRawMaterialCost(id) {
            if (!db || !userEmail) return;
            try {
                const costRef = doc(db, `artifacts/${appId}/public/data/rawMaterialCosts`, id);
                await deleteDoc(costRef);
                showToastNotification("üóëÔ∏è ‡∏•‡∏ö‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            } catch (error) {
                console.error("Error deleting raw material cost:", error);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };

        // --- NEW RECIPE MANAGEMENT FUNCTIONS ---
        let rawMaterialCount = 1;

        window.addRawMaterialField = () => {
            rawMaterialCount++;
            const container = document.getElementById('raw-materials-container');
            const newField = document.createElement('div');
            newField.classList.add('flex', 'space-x-2', 'items-end');
            newField.innerHTML = `
                <div class="flex-1">
                    <label for="raw-material-name-${rawMaterialCount}" class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label>
                    <input type="text" id="raw-material-name-${rawMaterialCount}" name="raw_material_name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏Ç‡πà‡πÑ‡∏Å‡πà" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex-1">
                    <label for="raw-material-quantity-${rawMaterialCount}" class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</label>
                    <input type="number" id="raw-material-quantity-${rawMaterialCount}" name="raw_material_quantity" value="1" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex-1">
                    <label for="raw-material-unit-${rawMaterialCount}" class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                    <input type="text" id="raw-material-unit-${rawMaterialCount}" name="raw_material_unit" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ü‡∏≠‡∏á, ‡∏Å‡∏£‡∏±‡∏°" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <button type="button" onclick="this.parentNode.remove()" class="px-3 py-2 bg-rose-500 text-white rounded-md hover:bg-rose-600">‡∏•‡∏ö</button>
            `;
            container.appendChild(newField);
        };

        document.getElementById('add-raw-material-btn').addEventListener('click', () => {
            window.addRawMaterialField();
        });

        document.getElementById('recipe-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!db || !userEmail) {
                console.error("Firebase is not initialized or user is not authenticated.");
                return;
            }

            const finishedProduct = document.getElementById('finished-product-name').value;
            const rawMaterials = [];
            const rawMaterialNames = document.querySelectorAll('input[name="raw_material_name"]');
            const rawMaterialQuantities = document.querySelectorAll('input[name="raw_material_quantity"]');
            const rawMaterialUnits = document.querySelectorAll('input[name="raw_material_unit"]');

            rawMaterialNames.forEach((nameInput, index) => {
                rawMaterials.push({
                    name: nameInput.value,
                    quantity: parseFloat(rawMaterialQuantities[index].value) || 0,
                    unit: rawMaterialUnits[index].value
                });
            });

            const data = {
                finished_product: finishedProduct,
                raw_materials: rawMaterials,
                recordedByUserEmail: userEmail
            };
            
            try {
                const recipesColRef = collection(db, `artifacts/${appId}/public/data/recipes`);
                await setDoc(doc(recipesColRef, finishedProduct), data);
                e.target.reset();
                document.getElementById('raw-materials-container').innerHTML = '';
                rawMaterialCount = 0;
                window.addRawMaterialField();
                console.log("Recipe saved successfully.");
                showToastNotification("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                const recipeMessage = `üìù **‡∏™‡∏π‡∏ï‡∏£‡πÉ‡∏´‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:** ‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${finishedProduct} ‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏î‡∏¢ ${userEmail}.`;
                sendDiscordMessage(recipeMessage);
            } catch (error) {
                console.error("Error saving recipe:", error);
            }
        });

        function setupRecipeListeners() {
            if (!db || !userEmail) return;
            const recipesColRef = collection(db, `artifacts/${appId}/public/data/recipes`);
            onSnapshot(recipesColRef, (querySnapshot) => {
                allRecipes = [];
                querySnapshot.forEach((doc) => {
                    allRecipes.push({ id: doc.id, ...doc.data() });
                });
                displayRecipes(allRecipes);
            });
        }

         // Function to calculate raw material cost when a menu item is selected
        function calculateRawMaterialCost() {
            const selectedMenu = document.getElementById('order-list-select').value;
            const rawMaterialCostInput = document.getElementById('raw_material_cost');
            let totalCost = 0;

            if (selectedMenu) {
                const recipe = allRecipes.find(r => r.finished_product === selectedMenu);
                if (recipe) {
                    recipe.raw_materials.forEach(material => {
                        const costPerUnit = rawMaterialCosts[material.name]?.cost_per_unit || 0;
                        totalCost += costPerUnit * (material.quantity || 0);
                    });
                }
            }

            rawMaterialCostInput.value = totalCost.toFixed(2);
        }
        
        function displayRecipes(recipes) {
            const tableBody = document.getElementById('recipe-table-body');
            tableBody.innerHTML = '';
            if (recipes.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏π‡∏ï‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</td></tr>`;
            }
            recipes.forEach(recipe => {
                const row = document.createElement('tr');
                row.classList.add('hover:bg-gray-50', 'text-gray-700', 'text-sm');
                const rawMaterialsList = recipe.raw_materials.map(mat => `${mat.name} (${mat.quantity} ${mat.unit})`).join(', ');
                row.innerHTML = `
                    <td class="px-4 py-2 border-b font-semibold">${recipe.finished_product}</td>
                    <td class="px-4 py-2 border-b text-sm">${rawMaterialsList}</td>
                    <td class="px-4 py-2 border-b text-center space-x-2 whitespace-nowrap">
                        <button onclick='window.showEditRecipeModal(${JSON.stringify(recipe)})' class="text-blue-500 hover:text-blue-700 font-medium">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button onclick="window.showDeleteRecipeModal('${recipe.id}')" class="text-red-500 hover:text-red-700 font-medium">‡∏•‡∏ö</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        window.showEditRecipeModal = (recipeData) => {
            modalTitle.textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏π‡∏ï‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö';
            let rawMaterialHtml = recipeData.raw_materials.map((mat, index) => `
                <div class="flex space-x-2 items-end">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label>
                        <input type="text" id="modal-raw-material-name-${index}" value="${mat.name}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</label>
                        <input type="number" id="modal-raw-material-quantity-${index}" value="${mat.quantity}" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                        <input type="text" id="modal-raw-material-unit-${index}" value="${mat.unit}" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <button type="button" onclick="this.parentNode.remove()" class="px-3 py-2 bg-rose-500 text-white rounded-md hover:bg-rose-600">‡∏•‡∏ö</button>
                </div>
            `).join('');

            modalBody.innerHTML = `
                <div class="space-y-4 text-left">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π</label>
                        <input type="text" id="modal-finished-product-name" value="${recipeData.finished_product}" class="w-full px-3 py-2 border border-gray-300 rounded-md" disabled>
                    </div>
                    <div id="modal-raw-materials-container" class="space-y-2">${rawMaterialHtml}</div>
                    <button type="button" id="modal-add-raw-material-btn" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</button>
                </div>
            `;

            document.getElementById('modal-add-raw-material-btn').addEventListener('click', () => {
                const container = document.getElementById('modal-raw-materials-container');
                const newField = document.createElement('div');
                newField.classList.add('flex', 'space-x-2', 'items-end');
                newField.innerHTML = `
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label>
                        <input type="text" name="modal-raw-material-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏Ç‡πà‡πÑ‡∏Å‡πà" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</label>
                        <input type="number" name="modal-raw-material-quantity" value="1" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                        <input type="text" name="modal-raw-material-unit" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ü‡∏≠‡∏á, ‡∏Å‡∏£‡∏±‡∏°" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <button type="button" onclick="this.parentNode.remove()" class="px-3 py-2 bg-rose-500 text-white rounded-md hover:bg-rose-600">‡∏•‡∏ö</button>
                `;
                container.appendChild(newField);
            });

            modalConfirm.onclick = () => {
                const newRawMaterials = [];
                const names = document.querySelectorAll('#modal-raw-materials-container input[name="modal-raw-material-name"]');
                const quantities = document.querySelectorAll('#modal-raw-materials-container input[name="modal-raw-material-quantity"]');
                const units = document.querySelectorAll('#modal-raw-materials-container input[name="modal-raw-material-unit"]');
                
                names.forEach((nameInput, index) => {
                    newRawMaterials.push({
                        name: nameInput.value,
                        quantity: parseFloat(quantities[index].value) || 0,
                        unit: units[index].value
                    });
                });

                editRecipe(recipeData.id, newRawMaterials);
                modal.style.display = 'none';
            };
            modalCancel.onclick = () => { modal.style.display = 'none'; };
            modal.style.display = 'flex';
        };

        window.showDeleteRecipeModal = (id) => {
            modalTitle.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏π‡∏ï‡∏£';
            modalBody.innerHTML = `<p>‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏™‡∏π‡∏ï‡∏£‡∏ô‡∏µ‡πâ?</p>`;
            modalConfirm.onclick = () => {
                deleteRecipe(id);
                modal.style.display = 'none';
            };
            modalCancel.onclick = () => { modal.style.display = 'none'; };
            modal.style.display = 'flex';
        };

        async function editRecipe(id, newRawMaterials) {
            if (!db || !userEmail) return;
            try {
                const recipeRef = doc(db, `artifacts/${appId}/public/data/recipes`, id);
                await updateDoc(recipeRef, { raw_materials: newRawMaterials, recordedByUserEmail: userEmail });
                console.log("Recipe updated successfully.");
                showToastNotification("‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                const recipeMessage = `‚úèÔ∏è **‡∏™‡∏π‡∏ï‡∏£‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:** ‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${id} ‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏î‡∏¢ ${userEmail}.`;
                sendDiscordMessage(recipeMessage);
            } catch (error) {
                console.error("Error updating recipe:", error);
            }
        }
        
        async function deleteRecipe(id) {
            if (!db || !userEmail) return;
            try {
                const recipeRef = doc(db, `artifacts/${appId}/public/data/recipes`, id);
                await deleteDoc(recipeRef);
                console.log("Recipe deleted successfully.");
                showToastNotification("üóëÔ∏è ‡∏•‡∏ö‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                const deleteMessage = `üóëÔ∏è **‡∏™‡∏π‡∏ï‡∏£‡∏ñ‡∏π‡∏Å‡∏•‡∏ö:** ‡∏™‡∏π‡∏ï‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${id} ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö. ‡πÇ‡∏î‡∏¢ ${userEmail}`;
                sendDiscordMessage(deleteMessage);
            } catch (error) {
                console.error("Error deleting recipe:", error);
            }
        }
    </script>
</head>

<body class="bg-gray-100 font-sans leading-normal tracking-normal bg-slate-50">
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-slate-800">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>
            <p class="text-lg text-slate-600 mt-2">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡πÇ‡∏Ñ‡∏£‡∏ï‡∏à‡∏∞‡πÅ‡∏°‡∏ô‡∏Æ‡∏≤‡∏•‡∏≤‡∏• ‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ‡πà</p>
        </header>

        <div id="low-stock-alert" class="hidden fixed top-0 left-0 right-0 bg-rose-500 text-white p-4 text-center z-50 shadow-lg">
        </div>

        <div id="loading-state" class="flex flex-col items-center justify-center min-h-[50vh]">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-slate-900 mx-auto"></div>
            <p class="mt-4 text-slate-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
        </div>
        
        <div id="login-content" class="flex flex-col items-center justify-center min-h-[50vh] hidden">
            <div class="bg-white p-8 rounded-xl shadow-xl text-center border border-slate-200">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</h2>
                <p class="text-slate-600 mb-6">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Google ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                <button id="login-btn" class="px-8 py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transform transition-transform duration-200 hover:scale-105">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ Google
                </button>
            </div>
        </div>

        <main id="main-content" class="hidden">
            <div class="flex justify-end mb-4">
                <button id="logout-btn" class="px-4 py-2 bg-slate-500 text-white font-semibold rounded-lg shadow-md hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-400">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
            
            <div class="bg-slate-100 p-3 rounded-lg text-slate-800 text-sm mb-6 shadow-sm border border-slate-200">
                üí° ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <span id="user-id" class="font-mono break-all font-bold text-indigo-600"></span>
            </div>

            <section class="bg-white p-6 rounded-xl shadow-xl mb-8 border border-slate-200">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                    <div class="bg-slate-800 p-6 rounded-xl shadow-lg">
                        <p class="text-lg text-slate-200">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°</p>
                        <p class="text-4xl font-extrabold text-emerald-400 mt-2">‡∏ø<span id="total-income">0.00</span></p>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-xl shadow-lg">
                        <p class="text-lg text-slate-200">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°</p>
                        <p class="text-4xl font-extrabold text-rose-400 mt-2">‡∏ø<span id="total-expense">0.00</span></p>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-xl shadow-lg">
                        <p class="text-lg text-slate-200">‡∏Å‡∏≥‡πÑ‡∏£/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô</p>
                        <p class="text-4xl font-extrabold text-white mt-2">‡∏ø<span id="total-profit">0.00</span></p>
                    </div>
                </div>
            </section>
            
            <section class="bg-white p-6 rounded-xl shadow-xl mb-8 border border-slate-200">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h2>
                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                    <select id="summary-month" class="w-full sm:w-1/2 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm"></select>
                    <select id="summary-year" class="w-full sm:w-1/2 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm"></select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                    <div class="bg-indigo-100 p-6 rounded-xl shadow-sm">
                        <p class="text-lg text-indigo-800">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                        <p class="text-4xl font-extrabold text-indigo-600 mt-2">‡∏ø<span id="monthly-income">0.00</span></p>
                    </div>
                    <div class="bg-rose-100 p-6 rounded-xl shadow-sm">
                        <p class="text-lg text-rose-800">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                        <p class="text-4xl font-extrabold text-rose-600 mt-2">‡∏ø<span id="monthly-expense">0.00</span></p>
                    </div>
                    <div class="bg-emerald-100 p-6 rounded-xl shadow-sm">
                        <p class="text-lg text-emerald-800">‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
                        <p class="text-4xl font-extrabold text-emerald-600 mt-2">‡∏ø<span id="monthly-profit">0.00</span></p>
                    </div>
                </div>
                 <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-bold text-slate-800 mb-4 text-center">‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</h3>
                        <canvas id="myChart"></canvas>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-slate-800 mb-4 text-center">‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h3>
                        <canvas id="myExpenseChart"></canvas>
                    </div>
                </div>
            </section>
            
            <section class="bg-white p-6 rounded-xl shadow-xl mb-8 border border-slate-200">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h2>
                <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="date" class="block text-sm font-semibold text-slate-700 mb-1">‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</label>
                        <input type="datetime-local" id="date" name="date" required
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div>
                        <label for="channel" class="block text-sm font-semibold text-slate-700 mb-1">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</label>
                        <select id="channel" name="channel" required
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</option>
                            <option value="ShopeeFood">ShopeeFood</option>
                            <option value="Lineman">Lineman</option>
                            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                        </select>
                    </div>
                    <div>
                        <label for="order_number" class="block text-sm font-semibold text-slate-700 mb-1">‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</label>
                        <input type="text" id="order_number" name="order_number" placeholder="‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div>
                        <label for="buyer_name" class="block text-sm font-semibold text-slate-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</label>
                        <input type="text" id="buyer_name" name="buyer_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div>
                        <label for="driver_name" class="block text-sm font-semibold text-slate-700 mb-1">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</label>
                        <input type="text" id="driver_name" name="driver_name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div>
                        <label for="item" class="block text-sm font-semibold text-slate-700 mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
                        <input type="text" id="item" name="item" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß, ‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div class="md:col-span-3">
                        <label for="order_list" class="block text-sm font-semibold text-slate-700 mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</label>
                        <textarea id="order_list" name="order_list" rows="3" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß, ‡∏Ç‡πâ‡∏≤‡∏ß‡πÑ‡∏Ç‡πà‡πÄ‡∏à‡∏µ‡∏¢‡∏ß"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm"></textarea>
                    </div>
                    <div>
                        <label for="income" class="block text-sm font-semibold text-slate-700 mb-1">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</label>
                        <input type="number" id="income" name="income" step="0.01" value="0.00"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div>
                        <label for="gp_fee_excl_vat" class="block text-sm font-semibold text-slate-700 mb-1">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ GP (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° VAT)</label>
                        <input type="number" id="gp_fee_excl_vat" name="gp_fee_excl_vat" step="0.01" value="0.00"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div>
                        <label for="shipping_discount_fee_excl_vat" class="block text-sm font-semibold text-slate-700 mb-1">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° VAT)</label>
                        <input type="number" id="shipping_discount_fee_excl_vat" name="shipping_discount_fee_excl_vat" step="0.01" value="0.00"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div>
                        <label for="vat_amount" class="block text-sm font-semibold text-slate-700 mb-1">‡∏Ñ‡πà‡∏≤ VAT</label>
                        <input type="number" id="vat_amount" name="vat_amount" step="0.01" value="0.00"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div>
                        <label for="raw_material_cost" class="block text-sm font-semibold text-slate-700 mb-1">‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label>
                        <input type="number" id="raw_material_cost" name="raw_material_cost" step="0.01" value="0.00"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div>
                        <label for="expense" class="block text-sm font-semibold text-slate-700 mb-1">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ</label>
                        <input type="number" id="expense" name="expense" step="0.01" value="0.00"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div class="md:col-span-3">
                        <label for="note" class="block text-sm font-semibold text-slate-700 mb-1">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <input type="text" id="note" name="note" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div class="md:col-span-3 text-right">
                        <button type="submit"
                            class="mt-4 px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transform transition-transform duration-200 hover:scale-105">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                        </button>
                    </div>
                </form>
            </section>
            
             <section class="bg-white p-6 rounded-xl shadow-xl mb-8 border border-slate-200">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á</h2>
                <form id="inventory-form" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div>
                        <label for="inventory-name" class="block text-sm font-semibold text-slate-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label>
                        <input type="text" id="inventory-name" name="inventory-name" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏Ç‡πà‡πÑ‡∏Å‡πà, ‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-200 focus:border-emerald-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div>
                        <label for="inventory-unit" class="block text-sm font-semibold text-slate-700 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</label>
                        <input type="text" id="inventory-unit" name="inventory-unit" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ü‡∏≠‡∏á, ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-200 focus:border-emerald-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div>
                        <label for="inventory-stock" class="block text-sm font-semibold text-slate-700 mb-1">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                        <input type="number" id="inventory-stock" name="inventory-stock" step="1" required value="0"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-200 focus:border-emerald-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div>
                        <label for="inventory-threshold" class="block text-sm font-semibold text-slate-700 mb-1">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</label>
                        <input type="number" id="inventory-threshold" name="inventory-threshold" step="1" required value="0"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-200 focus:border-emerald-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div class="md:col-span-4 text-right">
                        <button type="submit" class="mt-4 px-8 py-3 bg-emerald-600 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transform transition-transform duration-200 hover:scale-105">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ï‡πá‡∏≠‡∏Å
                        </button>
                    </div>
                </form>
                <div class="overflow-x-auto mt-8 rounded-xl shadow-sm border border-slate-200">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î</th>
                                <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body" class="bg-white divide-y divide-slate-200">
                            <!-- Inventory rows will be injected here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <h3 class="text-xl font-bold text-slate-800 mt-8 mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h3>
                <form id="raw-material-cost-form" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div>
                        <label for="cost-item-name" class="block text-sm font-semibold text-slate-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label>
                        <input type="text" id="cost-item-name" name="cost-item-name" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏Ç‡πà‡πÑ‡∏Å‡πà"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div>
                        <label for="cost-unit" class="block text-sm font-semibold text-slate-700 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</label>
                        <input type="text" id="cost-unit" name="cost-unit" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ü‡∏≠‡∏á, ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div>
                        <label for="cost-per-unit" class="block text-sm font-semibold text-slate-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                        <input type="number" id="cost-per-unit" name="cost-per-unit" step="0.01" required value="0.00"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div class="md:col-span-1 text-right self-end">
                        <button type="submit" class="w-full px-8 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transform transition-transform duration-200 hover:scale-105">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô
                        </button>
                    </div>
                </form>
                <div class="overflow-x-auto mt-8 rounded-xl shadow-sm border border-slate-200">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)</th>
                                <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="raw-material-cost-table-body" class="bg-white divide-y divide-slate-200">
                            <!-- Raw material cost rows will be injected here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <section class="bg-white p-6 rounded-xl shadow-xl mb-8 border border-slate-200">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ï‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h2>
                <form id="recipe-form" class="space-y-4">
                    <div>
                        <label for="finished-product-name" class="block text-sm font-semibold text-slate-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏°‡∏ô‡∏π/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ</label>
                        <input type="text" id="finished-product-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div id="raw-materials-container" class="space-y-2">
                        <!-- Raw material inputs will be added here -->
                        <div class="flex space-x-2 items-end">
                            <div class="flex-1">
                                <label for="raw-material-name-0" class="block text-sm font-semibold text-slate-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</label>
                                <input type="text" id="raw-material-name-0" name="raw_material_name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏™‡πâ‡∏ô‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div class="flex-1">
                                <label for="raw-material-quantity-0" class="block text-sm font-semibold text-slate-700 mb-1">‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì</label>
                                <input type="number" id="raw-material-quantity-0" name="raw_material_quantity" value="1" step="0.01" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <div class="flex-1">
                                <label for="raw-material-unit-0" class="block text-sm font-semibold text-slate-700 mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢</label>
                                <input type="text" id="raw-material-unit-0" name="raw_material_unit" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏£‡∏±‡∏°" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                            </div>
                            <button type="button" onclick="this.parentNode.remove()" class="px-4 py-2 bg-rose-500 text-white rounded-lg hover:bg-rose-600">‡∏•‡∏ö</button>
                        </div>
                    </div>
                    <div class="flex space-x-2 mt-4">
                        <button type="button" id="add-raw-material-btn" class="flex-1 px-4 py-2 bg-slate-200 text-slate-800 rounded-lg shadow-sm hover:bg-slate-300">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö
                        </button>
                        <button type="submit" class="flex-1 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏π‡∏ï‡∏£
                        </button>
                    </div>
                </form>
                <div class="overflow-x-auto mt-8 rounded-xl shadow-sm border border-slate-200">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">‡πÄ‡∏°‡∏ô‡∏π/‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏™‡∏π‡∏ï‡∏£‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</th>
                                <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="recipe-table-body" class="bg-white divide-y divide-slate-200">
                            <!-- Recipe rows will be injected here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>


            <section class="bg-white p-6 rounded-xl shadow-xl mb-8 border border-slate-200">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°</h2>
                <div class="flex flex-col md:flex-row gap-4 mb-4 items-end">
                    <div class="w-full md:w-1/2">
                        <input type="text" id="search-query" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå, ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠, ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div class="w-full md:w-1/4">
                        <select id="filter-channel" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                            <option value="">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="ShopeeFood">ShopeeFood</option>
                            <option value="Lineman">Lineman</option>
                            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                        </select>
                    </div>
                    <div class="w-full md:w-auto flex-none flex gap-2">
                        <button id="export-csv-btn" class="w-1/2 md:w-auto px-4 py-2 bg-emerald-600 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</button>
                        <button id="export-excel-btn" class="w-1/2 md:w-auto px-4 py-2 bg-emerald-600 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Excel</button>
                        <button id="reset-filters-btn" class="w-1/2 md:w-auto px-4 py-2 bg-slate-500 text-white font-semibold rounded-lg shadow-md hover:bg-slate-600">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                    </div>
                </div>
                <div class="flex flex-col md:flex-row gap-4 mb-4">
                    <div class="w-full md:w-1/2 flex items-center gap-2">
                        <label for="filter-start-date" class="block text-sm font-semibold text-slate-700 whitespace-nowrap">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</label>
                        <input type="date" id="filter-start-date" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                    <div class="w-full md:w-1/2 flex items-center gap-2">
                        <label for="filter-end-date" class="block text-sm font-semibold text-slate-700 whitespace-nowrap">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label>
                        <input type="date" id="filter-end-date" class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-400 text-slate-700 bg-slate-50 shadow-sm">
                    </div>
                </div>
                <div class="overflow-x-auto rounded-xl shadow-sm border border-slate-200">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πâ‡∏≠</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (‡∏ö‡∏≤‡∏ó)</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏Ñ‡πà‡∏≤ GP (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° VAT)</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° VAT)</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏Ñ‡πà‡∏≤ VAT</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (‡∏ö‡∏≤‡∏ó)</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏ö‡∏≤‡∏ó)</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏Å‡∏≥‡πÑ‡∏£ (‡∏ö‡∏≤‡∏ó)</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (‡∏≠‡∏µ‡πÄ‡∏°‡∏•)</th>
                                <th scope="col" class="px-4 py-3 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-table-body" class="bg-white divide-y divide-slate-200">
                            <!-- Transaction rows will be injected here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </section>
            
            <section class="bg-white p-6 rounded-xl shadow-xl mb-8 border border-slate-200">
                <h2 class="text-2xl font-bold text-slate-800 mb-4">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h2>
                <div class="flex justify-center">
                    <iframe src="https://calendar.google.com/calendar/embed?src=68b44e6f253c9b89f4215cc51e417104f7cd236496dd26e56d8f2690998b7e04%40group.calendar.google.com&ctz=Asia%2FBangkok" 
                            style="border: 0" width="800" height="600" frameborder="0" scrolling="no" class="rounded-xl shadow-md">
                    </iframe>
                </div>
            </section>

        </main>

        <!-- Modal for user interaction -->
        <div id="modal" class="modal">
            <div class="modal-content">
                <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
                <div id="modal-body" class="mb-4"></div>
                <div class="flex justify-center space-x-4">
                    <button id="modal-confirm" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                    <button id="modal-cancel" class="px-4 py-2 bg-slate-300 text-slate-800 rounded-lg hover:bg-slate-400 font-semibold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </div>
        </div>
        <div id="toast-notification" class="toast-notification"></div>

    </div>
    <footer class="text-center p-4 text-slate-600 text-sm mt-8 border-t border-slate-300">
        <p>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•: safaree LBS</p>
        <p>Tel. 097-197-0933</p>
        <p>&copy; 2025 webdelivery</p>
    </footer>
</body>

</html>

